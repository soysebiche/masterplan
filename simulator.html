<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Your Financial Plan - MasterPlan</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="design-tokens.css">
    <link rel="stylesheet" href="components/components.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap"
        rel="stylesheet">
    <style>
        * {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }

        h1 {
            font-family: 'Plus Jakarta Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }

        body {
            background: linear-gradient(to bottom, #fafbfc 0%, #ffffff 100%);
        }

        .gradient-text {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        input[type="text"],
        input[type="number"] {
            border: 2px solid #e5e7eb;
            width: 100%;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            font-size: 1rem;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        input[type="text"]:focus,
        input[type="number"]:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
            /* Thicker ring */
            transform: translateY(-1px);
            /* Subtle lift */
        }

        .auth-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }

        .auth-modal {
            background: white;
            border-radius: 1.5rem;
            padding: 3rem;
            max-width: 500px;
            width: 100%;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }

        /* Step Navigation - Sticky & Interactive */
        .steps-navigation {
            position: sticky;
            top: 4.5rem; /* Below header */
            z-index: 40; /* Below header (z-50) */
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            margin-top: -1rem; /* Negative margin to eliminate gap */
            padding-top: 1rem; /* Restore spacing visually */
            background: #FFFFFF; /* Solid background to cover gap */
        }

        .steps-navigation::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1rem; /* Height to cover the gap */
            background: #FFFFFF;
            z-index: -1;
        }

        .steps-navigation > div {
            background: #FFFFFF !important;
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        .step-indicator {
            position: relative;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            font-weight: 500;
            color: #6B7280;
            background: #FFFFFF;
            border: 1px solid #E5E7EB;
            cursor: pointer;
            transition: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
            text-align: center;
            flex: 1;
            min-width: 0;
        }

        .step-indicator:hover {
            background: #F9FAFB;
            border-color: #D1D5DB;
            color: #111827;
        }

        .step-indicator.active {
            background: #4F46E5;
            color: #FFFFFF;
            border-color: #4F46E5;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
        }

        .step-indicator.active::before {
            content: '';
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 3px;
            height: 60%;
            background: #FFFFFF;
            border-radius: 0 2px 2px 0;
        }

        .step-indicator.completed {
            background: #EEF2FF;
            color: #4F46E5;
            border-color: #C7D2FE;
        }

        .step-indicator.completed::after {
            content: '✓';
            margin-left: 0.25rem;
            font-weight: 600;
        }

        @media (max-width: 768px) {
            .steps-navigation {
                top: 4.5rem; /* Slightly less on mobile for smaller header */
            }
            
            .step-indicator {
                font-size: 0.75rem;
                padding: 0.5rem 0.75rem;
            }
        }
    </style>
    <!-- Hotjar Tracking Code for https://masterplan-92uay74xk-sebbs21s-projects.vercel.app/ -->
    <script type="module" src="./js/auth-state.js"></script>
    <script type="module">
        import { auth, onAuthStateChanged } from './js/firebase-config.js';

        onAuthStateChanged(auth, (user) => {
            if (!user) {
                // Show auth overlay if not logged in
                const mainContent = document.getElementById('main-content');
                if (mainContent) {
                    mainContent.style.opacity = '0.3';
                    mainContent.style.pointerEvents = 'none';
                }

                const overlay = document.createElement('div');
                overlay.className = 'auth-overlay';
                overlay.innerHTML = `
                    <div class="auth-modal text-center">
                        <div class="w-20 h-20 bg-gradient-to-br from-indigo-600 to-purple-600 rounded-full mx-auto mb-6 flex items-center justify-center">
                            <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                            </svg>
                        </div>
                        <h2 class="text-3xl font-bold text-gray-900 mb-3">Create Your Account First</h2>
                        <p class="text-gray-600 mb-4">To start creating your financial plan, please create a free account. It only takes a minute!</p>
                        <div class="space-y-3">
                            <a href="signupmodal.html" class="gradient-bg text-white px-8 py-4 rounded-xl font-semibold hover:shadow-2xl transition-all transform hover:-translate-y-1 inline-block w-full">
                                Create Free Account
                            </a>

                        </div>
                    </div>
                `;
                document.body.appendChild(overlay);
            } else {
                // Remove overlay if it exists (e.g. if user logs in in another tab, though unlikely to affect this tab without reload, but good practice)
                const overlay = document.querySelector('.auth-overlay');
                if (overlay) {
                    overlay.remove();
                    const mainContent = document.getElementById('main-content');
                    if (mainContent) {
                        mainContent.style.opacity = '1';
                        mainContent.style.pointerEvents = 'auto';
                    }
                }
            }
        });
    </script>

    <script>
        // Check for comparison mode
        document.addEventListener('DOMContentLoaded', function () {
            const params = new URLSearchParams(window.location.search);
            if (params.get('mode') === 'compare') {
                document.getElementById('page-title').textContent = 'Select Program to Compare';
                document.getElementById('page-subtitle').textContent = 'Find a second program to compare against your first choice';

                // Pre-fill funds from session storage if available (optional, but good UX)
                const storedParams = new URLSearchParams(sessionStorage.getItem('compare_program_a'));
                if (storedParams) {
                    if (storedParams.get('savings')) document.getElementById('input-savings').value = storedParams.get('savings');
                    if (storedParams.get('family')) document.getElementById('input-family').value = storedParams.get('family');
                    if (storedParams.get('scholarships')) document.getElementById('input-scholarships').value = storedParams.get('scholarships');
                }
            }
        });
    </script>
</head>

<body class="antialiased">
    <!-- Navigation -->
    <nav class="bg-white/80 backdrop-blur-md border-b border-gray-100 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-6 py-4">
            <div class="flex justify-between items-center">
                <a href="index.html" class="flex items-center gap-2">
                    <!-- Logo SVG -->
                    <div class="w-8 h-8">
                        <svg viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M20 35 L35 27 L35 65 L20 73 Z" fill="#3730A3" />
                            <path d="M20 35 L35 27 L50 35 L35 43 Z" fill="#6366F1" />
                            <path d="M35 43 L50 35 L50 55 L35 63 Z" fill="#D1D5DB" />
                            <path d="M35 43 L50 35 L65 43 L50 51 Z" fill="#E5E7EB" />
                            <path d="M65 43 L80 35 L80 73 L65 81 Z" fill="#6366F1" />
                            <path d="M65 43 L80 35 L65 27 L50 35 Z" fill="#818CF8" />
                            <path d="M35 63 L50 55 L50 73 L35 81 Z" fill="#9CA3AF" />
                            <path d="M50 55 L65 47 L65 81 L50 73 Z" fill="#A5B4FC" />
                            <path d="M20 73 L35 65 L35 81 Z" fill="#4338CA" />
                            <path d="M65 81 L80 73 L65 65 Z" fill="#4F46E5" />
                        </svg>
                    </div>
                    <!-- Text -->
                    <span class="text-2xl font-bold gradient-text">MasterPlan</span>
                </a>
                <div class="hidden md:flex items-center space-x-8">
                    <a href="dashboard.html" id="nav-dashboard" style="display: none"
                        class="text-gray-700 hover:text-gray-900 font-medium transition-colors">Dashboard</a>
                    <a href="simulator.html" id="nav-simulator"
                        class="text-gray-900 font-semibold border-b-2 border-indigo-600 pb-1">Simulator</a>
                    <a href="pricing.html" id="nav-pricing"
                        class="text-gray-700 hover:text-gray-900 font-medium transition-colors">Pricing</a>
                    <div id="user-profile-section" class="flex items-center space-x-3">
                        <!-- User profile will be populated by auth-state.js -->
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="max-w-6xl mx-auto px-6 py-6" id="main-content">
        <div class="text-center mb-6">
            <h1 id="page-title" class="text-4xl md:text-5xl font-bold text-gray-900 mb-4">Create Your Financial Plan
            </h1>
            <p id="page-subtitle" class="text-xl text-gray-600">5 questions between you and clarity
            </p>
        </div>

        <!-- Sticky Step Navigation -->
        <div class="steps-navigation mb-4">
            <div class="bg-white rounded-lg border border-gray-200 p-3" style="background: #FFFFFF !important;">
                <div class="flex justify-around gap-2 flex-wrap">
                    <div class="step-indicator" id="step-1-indicator" onclick="scrollToStep(1)">1. Programs</div>
                    <div class="step-indicator" id="step-2-indicator" onclick="scrollToStep(2)">2. Funds</div>
                    <div class="step-indicator" id="step-3-indicator" onclick="scrollToStep(3)">3. Hidden Costs</div>
                    <div class="step-indicator" id="step-4-indicator" onclick="scrollToStep(4)">4. Lifestyle</div>
                    <div class="step-indicator" id="step-5-indicator" onclick="scrollToStep(5)">5. Income</div>
                </div>
            </div>
        </div>



        <!-- Step 1: Programs -->
        <section id="step-1" class="bg-white rounded-xl border border-gray-200 p-8 mb-4 shadow-sm">
            <div class="flex justify-between items-start mb-6">
                <div>
                    <h2 class="text-2xl font-bold text-gray-900 mb-2">Step 1: Find Your Program</h2>
                    <p class="text-sm text-gray-500">Search from 2,800+ programs across 450+ universities worldwide</p>
                </div>
            </div>

            <!-- Single Intelligent Search Bar -->
            <div class="mb-6">
                <label class="block text-sm font-semibold text-gray-700 mb-3">Search for university or program</label>
                <div class="relative">
                    <div class="flex items-center border-2 border-gray-200 rounded-lg focus-within:border-indigo-500 focus-within:ring-4 focus-within:ring-indigo-100 transition-all bg-white">
                        <div class="pl-4 pr-3 flex items-center pointer-events-none">
                            <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                            </svg>
                        </div>
                        <input type="text" id="intelligent-search"
                            class="flex-1 py-4 pr-4 text-base border-0 focus:outline-none focus:ring-0 bg-transparent"
                            placeholder="Try 'Spain', 'Harvard MBA', or 'Master of Finance'..." autocomplete="off"
                            oninput="intelligentSearch(this.value)">
                    </div>
                    <div id="search-results"
                        class="max-h-96 overflow-y-auto border border-gray-200 border-t-0 absolute w-full bg-white/95 backdrop-blur-md z-10 rounded-b-lg shadow-lg hidden mt-1">
                    </div>
                </div>
                <p class="text-xs text-gray-500 mt-2">Search by country, university, or program</p>
            </div>

            <!-- Selected Programs -->
            <div id="selectedPrograms" class="grid grid-cols-1 gap-4 mb-6"></div>

            <!-- Smart Recommendations (shows after first program selected) -->
            <div id="smart-recommendations"
                class="hidden mt-6 bg-gradient-to-br from-indigo-50 to-purple-50 rounded-xl border border-indigo-200 p-6">
                <h3 class="text-lg font-bold text-gray-900 mb-3">Students like you also considered...</h3>
                <div id="recommendations-list" class="grid grid-cols-1 md:grid-cols-3 gap-4"></div>
            </div>

            <p id="emptyState"
                class="text-center text-gray-500 py-12 border-2 border-dashed border-gray-200 rounded-lg">
                <svg class="w-12 h-12 mx-auto mb-3 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                </svg>
                <span class="block font-medium text-gray-700 mb-1">Start your search</span>
                <span class="block text-sm">Type a university name or program to begin</span>
            </p>
        </section>

        <script>
            // Global state
            window.searchMethod = null;
            window.selectedPrograms = [];
            window.selectedCountry = null;
            window.selectedUniversity = null;
            window.selectedProgram = null;

            // Countries database (25-30 top countries) - sorted alphabetically
            const countries = [
                { code: 'AR', name: 'Argentina', livingCost: 600 },
                { code: 'AU', name: 'Australia', livingCost: 1300 },
                { code: 'AT', name: 'Austria', livingCost: 1000 },
                { code: 'BE', name: 'Belgium', livingCost: 1050 },
                { code: 'BR', name: 'Brazil', livingCost: 650 },
                { code: 'CA', name: 'Canada', livingCost: 1200 },
                { code: 'CN', name: 'China', livingCost: 800 },
                { code: 'DK', name: 'Denmark', livingCost: 1300 },
                { code: 'FI', name: 'Finland', livingCost: 1100 },
                { code: 'FR', name: 'France', livingCost: 1200 },
                { code: 'DE', name: 'Germany', livingCost: 1000 },
                { code: 'HK', name: 'Hong Kong', livingCost: 1500 },
                { code: 'IE', name: 'Ireland', livingCost: 1250 },
                { code: 'IT', name: 'Italy', livingCost: 950 },
                { code: 'JP', name: 'Japan', livingCost: 1300 },
                { code: 'MX', name: 'Mexico', livingCost: 700 },
                { code: 'NL', name: 'Netherlands', livingCost: 1100 },
                { code: 'NZ', name: 'New Zealand', livingCost: 1100 },
                { code: 'NO', name: 'Norway', livingCost: 1400 },
                { code: 'PT', name: 'Portugal', livingCost: 850 },
                { code: 'RU', name: 'Russia', livingCost: 600 },
                { code: 'SG', name: 'Singapore', livingCost: 1400 },
                { code: 'ES', name: 'Spain', livingCost: 900 },
                { code: 'SE', name: 'Sweden', livingCost: 1200 },
                { code: 'CH', name: 'Switzerland', livingCost: 1600 },
                { code: 'UK', name: 'United Kingdom', livingCost: 1400 },
                { code: 'US', name: 'United States', livingCost: 1500 }
            ];

            // Programs database (80-100 common graduate programs)
            const programs = [
                'MBA', 'Master of Finance', 'Master of Accounting', 'Master in Management',
                'Master of Marketing', 'Master of Business Analytics', 'Master of Data Science',
                'Master of Computer Science', 'Master of Information Systems', 'Master of Engineering',
                'Master of Civil Engineering', 'Master of Mechanical Engineering', 'Master of Electrical Engineering',
                'Master of Chemical Engineering', 'Master of Aerospace Engineering', 'Master of Biomedical Engineering',
                'Master of Economics', 'Master of Public Policy', 'Master of International Relations',
                'Master of Law (LLM)', 'Master of Public Health', 'Master of Social Work',
                'Master of Education', 'Master of Psychology', 'Master of Clinical Psychology',
                'Master of Architecture', 'Master of Urban Planning', 'Master of Design',
                'Master of Fine Arts', 'Master of Journalism', 'Master of Communications',
                'Master of Public Administration', 'Master of Healthcare Administration', 'Master of Supply Chain',
                'Master of Operations Management', 'Master of Human Resources', 'Master of Entrepreneurship',
                'Master of Innovation', 'Master of Sustainability', 'Master of Environmental Science',
                'Master of Biotechnology', 'Master of Pharmaceutical Sciences', 'Master of Nursing',
                'Master of Medicine', 'Master of Dentistry', 'Master of Veterinary Medicine',
                'Master of Agriculture', 'Master of Food Science', 'Master of Nutrition',
                'Master of Sports Management', 'Master of Hospitality', 'Master of Tourism',
                'Master of Real Estate', 'Master of Construction Management', 'Master of Project Management',
                'Master of Quality Management', 'Master of Risk Management', 'Master of Insurance',
                'Master of Actuarial Science', 'Master of Statistics', 'Master of Mathematics',
                'Master of Physics', 'Master of Chemistry', 'Master of Biology',
                'Master of Genetics', 'Master of Neuroscience', 'Master of Cognitive Science',
                'Master of Linguistics', 'Master of Literature', 'Master of History',
                'Master of Philosophy', 'Master of Theology', 'Master of Religious Studies',
                'Master of Anthropology', 'Master of Sociology', 'Master of Political Science',
                'Master of Geography', 'Master of Geology', 'Master of Oceanography',
                'Master of Meteorology', 'Master of Astronomy', 'Master of Astrophysics',
                'Master of Materials Science', 'Master of Nanotechnology', 'Master of Robotics',
                'Master of Artificial Intelligence', 'Master of Machine Learning', 'Master of Cybersecurity',
                'Master of Digital Marketing', 'Master of E-commerce', 'Master of Fintech'
            ];

            // Initialize step 1 as active (Step 0 removed)
            document.getElementById('step-1-indicator').classList.add('active');

            // Step Navigation - Scroll Detection & Interaction
            function scrollToStep(stepNumber) {
                const section = document.getElementById(`step-${stepNumber}`);
                if (section) {
                    // Calculate offset: header height (~64px) + steps nav height (~60px) + spacing
                    const headerHeight = 64; // Approximate header height
                    const stepsNavHeight = 60; // Approximate steps nav height
                    const offset = headerHeight + stepsNavHeight + 20; // Extra spacing
                    const elementPosition = section.getBoundingClientRect().top + window.pageYOffset;
                    const offsetPosition = elementPosition - offset;
                    
                    window.scrollTo({
                        top: offsetPosition,
                        behavior: 'smooth'
                    });
                }
            }

            // Intersection Observer for step indicators
            function initStepObserver() {
                const steps = [
                    { id: 'step-1', indicator: 'step-1-indicator' },
                    { id: 'step-2', indicator: 'step-2-indicator' },
                    { id: 'step-3', indicator: 'step-3-indicator' },
                    { id: 'step-4', indicator: 'step-4-indicator' },
                    { id: 'step-5', indicator: 'step-5-indicator' }
                ];

                const options = {
                    root: null,
                    rootMargin: '-20% 0px -60% 0px', // Trigger when section is in upper 40% of viewport
                    threshold: 0
                };

                const observer = new IntersectionObserver((entries) => {
                    entries.forEach(entry => {
                        const stepId = entry.target.id;
                        const stepData = steps.find(s => s.id === stepId);
                        
                        if (stepData) {
                            const indicator = document.getElementById(stepData.indicator);
                            if (indicator) {
                                if (entry.isIntersecting) {
                                    // Remove active from all indicators
                                    steps.forEach(s => {
                                        const ind = document.getElementById(s.indicator);
                                        if (ind) {
                                            ind.classList.remove('active', 'completed');
                                        }
                                    });
                                    // Add active to current indicator
                                    indicator.classList.add('active');
                                    
                                    // Mark previous steps as completed
                                    const currentIndex = steps.findIndex(s => s.id === stepId);
                                    for (let i = 0; i < currentIndex; i++) {
                                        const prevIndicator = document.getElementById(steps[i].indicator);
                                        if (prevIndicator) {
                                            prevIndicator.classList.add('completed');
                                        }
                                    }
                                }
                            }
                        }
                    });
                }, options);

                // Observe all step sections
                steps.forEach(step => {
                    const section = document.getElementById(step.id);
                    if (section) {
                        observer.observe(section);
                    }
                });

                // Additional check for when user scrolls to bottom - activate step 5 if near bottom
                function checkBottomScroll() {
                    const windowHeight = window.innerHeight;
                    const documentHeight = document.documentElement.scrollHeight;
                    const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
                    const scrollBottom = scrollTop + windowHeight;
                    
                    // If within 200px of bottom, activate step 5
                    if (documentHeight - scrollBottom < 200) {
                        const step5Indicator = document.getElementById('step-5-indicator');
                        const step5Section = document.getElementById('step-5');
                        if (step5Section && step5Indicator) {
                            // Check if step 5 is actually visible (even if not in the top 40%)
                            const rect = step5Section.getBoundingClientRect();
                            if (rect.top < windowHeight && rect.bottom > 0) {
                                // Remove active from all indicators
                                steps.forEach(s => {
                                    const ind = document.getElementById(s.indicator);
                                    if (ind) {
                                        ind.classList.remove('active', 'completed');
                                    }
                                });
                                // Activate step 5
                                step5Indicator.classList.add('active');
                                // Mark previous steps as completed
                                for (let i = 0; i < 4; i++) {
                                    const prevIndicator = document.getElementById(steps[i].indicator);
                                    if (prevIndicator) {
                                        prevIndicator.classList.add('completed');
                                    }
                                }
                            }
                        }
                    }
                }

                // Check on scroll
                window.addEventListener('scroll', checkBottomScroll);
                // Also check on load in case page loads at bottom
                checkBottomScroll();
            }

            // Initialize on DOM ready
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initStepObserver);
            } else {
                initStepObserver();
            }

            // Make scrollToStep available globally
            window.scrollToStep = scrollToStep;

            // Universities database - comprehensive list by country
            function generateUniversitiesDatabase() {
                const universitiesData = [];

                // USA Universities (22 top universities)
                const usaUnis = [
                    'Harvard University', 'Stanford University', 'MIT', 'University of Pennsylvania (Wharton)',
                    'Columbia University', 'University of Chicago (Booth)', 'Northwestern University (Kellogg)',
                    'Yale University', 'Duke University (Fuqua)', 'University of California, Berkeley (Haas)',
                    'University of Michigan (Ross)', 'Cornell University (Johnson)', 'UCLA (Anderson)',
                    'New York University (Stern)', 'Carnegie Mellon University (Tepper)', 'University of Texas (McCombs)',
                    'University of Virginia (Darden)', 'Georgetown University (McDonough)', 'Vanderbilt University (Owen)',
                    'Emory University (Goizueta)', 'University of North Carolina (Kenan-Flagler)', 'Indiana University (Kelley)'
                ];

                // UK Universities
                const ukUnis = [
                    'University of Oxford', 'University of Cambridge', 'London Business School', 'Imperial College London',
                    'London School of Economics', 'University of Warwick', 'University of Manchester', 'University of Edinburgh',
                    'King\'s College London', 'University of Bristol', 'Durham University', 'University of Leeds'
                ];

                // European Universities by country
                const europeUnis = {
                    'ES': ['IE Business School', 'ESADE Business School', 'IESE Business School', 'Universidad Carlos III de Madrid'],
                    'FR': ['INSEAD', 'HEC Paris', 'ESSEC Business School', 'Sciences Po Paris'],
                    'DE': ['WHU - Otto Beisheim School', 'Mannheim Business School', 'Frankfurt School of Finance', 'ESMT Berlin'],
                    'NL': ['Rotterdam School of Management', 'Amsterdam Business School', 'Maastricht University'],
                    'CH': ['University of St. Gallen', 'IMD Business School', 'University of Zurich'],
                    'IT': ['Bocconi University', 'SDA Bocconi', 'MIB School of Management'],
                    'SE': ['Stockholm School of Economics', 'Lund University', 'Uppsala University'],
                    'NO': ['BI Norwegian Business School', 'NHH Norwegian School of Economics'],
                    'DK': ['Copenhagen Business School', 'Aarhus University'],
                    'FI': ['Aalto University', 'Hanken School of Economics'],
                    'BE': ['Vlerick Business School', 'Solvay Brussels School'],
                    'AT': ['Vienna University of Economics', 'WU Vienna'],
                    'IE': ['Trinity College Dublin', 'University College Dublin'],
                    'PT': ['Nova School of Business', 'Católica Lisbon School']
                };

                // Other countries
                const otherUnis = {
                    'CA': ['University of Toronto (Rotman)', 'Western University (Ivey)', 'McGill University', 'University of British Columbia (Sauder)'],
                    'AU': ['University of Melbourne', 'University of Sydney', 'Australian National University', 'UNSW Sydney'],
                    'NZ': ['University of Auckland', 'University of Otago', 'Victoria University of Wellington'],
                    'MX': ['EGADE Business School', 'IPADE Business School', 'Tecnológico de Monterrey'],
                    'BR': ['Fundação Getulio Vargas', 'INSPER', 'IBMEC'],
                    'AR': ['Universidad de Buenos Aires', 'Universidad Torcuato di Tella'],
                    'JP': ['University of Tokyo', 'Waseda University', 'Keio University'],
                    'CN': ['Tsinghua University', 'Peking University', 'Fudan University'],
                    'HK': ['University of Hong Kong', 'Hong Kong University of Science and Technology', 'Chinese University of Hong Kong'],
                    'SG': ['National University of Singapore', 'Nanyang Technological University', 'Singapore Management University'],
                    'RU': ['Moscow State University', 'St. Petersburg State University', 'Higher School of Economics']
                };

                // Generate combinations for each program
                programs.forEach(program => {
                    // USA
                    usaUnis.forEach(uni => {
                        const tuition = Math.floor(Math.random() * 80000) + 60000;
                        const duration = [12, 15, 18, 21, 24][Math.floor(Math.random() * 5)];
                        universitiesData.push({
                            name: uni,
                            country: 'US',
                            countryName: 'United States',
                            program: program,
                            tuition: tuition,
                            duration: duration,
                            livingCost: 1500
                        });
                    });

                    // UK
                    ukUnis.forEach(uni => {
                        const tuition = Math.floor(Math.random() * 50000) + 40000;
                        const duration = [12, 15, 18, 21][Math.floor(Math.random() * 4)];
                        universitiesData.push({
                            name: uni,
                            country: 'UK',
                            countryName: 'United Kingdom',
                            program: program,
                            tuition: tuition,
                            duration: duration,
                            livingCost: 1400
                        });
                    });

                    // Europe
                    Object.keys(europeUnis).forEach(countryCode => {
                        const country = countries.find(c => c.code === countryCode);
                        if (country) {
                            europeUnis[countryCode].forEach(uni => {
                                const baseTuition = country.livingCost * 40;
                                const tuition = Math.floor(baseTuition * (0.8 + Math.random() * 0.4));
                                const duration = [10, 12, 15, 18][Math.floor(Math.random() * 4)];
                                universitiesData.push({
                                    name: uni,
                                    country: countryCode,
                                    countryName: country.name,
                                    program: program,
                                    tuition: tuition,
                                    duration: duration,
                                    livingCost: country.livingCost
                                });
                            });
                        }
                    });

                    // Other countries
                    Object.keys(otherUnis).forEach(countryCode => {
                        const country = countries.find(c => c.code === countryCode);
                        if (country) {
                            otherUnis[countryCode].forEach(uni => {
                                const baseTuition = country.livingCost * 40;
                                const tuition = Math.floor(baseTuition * (0.8 + Math.random() * 0.4));
                                const duration = [12, 15, 18, 21][Math.floor(Math.random() * 4)];
                                universitiesData.push({
                                    name: uni,
                                    country: countryCode,
                                    countryName: country.name,
                                    program: program,
                                    tuition: tuition,
                                    duration: duration,
                                    livingCost: country.livingCost
                                });
                            });
                        }
                    });
                });

                return universitiesData;
            }

            const universitiesDatabase = generateUniversitiesDatabase();

            // Intelligent search function - searches universities, programs, AND countries
            window.intelligentSearch = function (query) {
                const resultsDiv = document.getElementById('search-results');

                if (query.length < 2) {
                    resultsDiv.classList.add('hidden');
                    return;
                }

                const queryLower = query.toLowerCase();
                
                // Search in universitiesDatabase for matches in university name, program name, OR country name
                const matches = universitiesDatabase.filter(item => {
                    const uniMatch = item.name.toLowerCase().includes(queryLower);
                    const programMatch = item.program.toLowerCase().includes(queryLower);
                    const countryMatch = item.countryName.toLowerCase().includes(queryLower);
                    return uniMatch || programMatch || countryMatch;
                }).slice(0, 12); // Limit to 12 results

                if (matches.length === 0) {
                    resultsDiv.innerHTML = '<div class="search-result p-4 text-center text-gray-500">No programs found. Try searching by country, university, or program name.</div>';
                } else {
                    // Group by match type for better UX
                    resultsDiv.innerHTML = matches.map(item => {
                        // Highlight what matched
                        const uniMatch = item.name.toLowerCase().includes(queryLower);
                        const countryMatch = item.countryName.toLowerCase().includes(queryLower);
                        
                        return `
                        <div class="border-b border-gray-100 px-4 py-3 cursor-pointer hover:bg-gray-50 transition-all"
                             onclick="selectProgram('${item.name.replace(/'/g, "\\'")}', '${item.program.replace(/'/g, "\\'")}', '${item.country}', '${item.countryName}', ${item.tuition}, ${item.duration}, ${item.livingCost})">
                            <div class="flex items-center gap-2">
                                <span class="font-semibold text-gray-900">${item.name}</span>
                                <span class="text-xs px-2 py-0.5 rounded-full ${countryMatch ? 'bg-indigo-100 text-indigo-700' : 'bg-gray-100 text-gray-600'}">${item.countryName}</span>
                            </div>
                            <div class="text-sm text-gray-600">${item.program}</div>
                            <div class="text-sm font-bold text-indigo-600 mt-1">$${item.tuition.toLocaleString()} • ${item.duration} months</div>
                        </div>
                    `}).join('');
                }

                resultsDiv.classList.remove('hidden');
            };

            // Select a program from search results
            window.selectProgram = function (uniName, programName, countryCode, countryName, tuition, duration, livingCost) {
                // Check if already selected
                const alreadySelected = window.selectedPrograms.find(p =>
                    p.name === uniName && p.program === programName
                );

                if (alreadySelected) {
                    alert('This program is already selected');
                    return;
                }

                // Add to selected programs
                window.selectedPrograms.push({
                    name: uniName,
                    location: `${countryName} - ${uniName}`,
                    tuition: `$${tuition.toLocaleString()}`,
                    duration: `${duration} months`,
                    program: programName,
                    country: countryCode,
                    countryName: countryName,
                    livingCost: livingCost,
                    tuitionNum: tuition,
                    durationNum: duration
                });

                // Clear search and hide results
                document.getElementById('intelligent-search').value = '';
                document.getElementById('search-results').classList.add('hidden');

                // Hide empty state and render programs
                document.getElementById('emptyState').classList.add('hidden');
                renderSelectedPrograms();

                // Generate smart recommendations
                generateSmartRecommendations();
            };

            // Smart Recommendations System
            window.generateSmartRecommendations = function () {
                if (window.selectedPrograms.length === 0) {
                    document.getElementById('smart-recommendations').classList.add('hidden');
                    return;
                }

                // Get first selected program as reference
                const reference = window.selectedPrograms[0];

                // Find similar programs based on:
                // 1. Same program type, different country (cheaper)
                // 2. Same country, different program
                // 3. Similar tuition range (±20%)

                const recommendations = [];
                const selectedNames = window.selectedPrograms.map(p => `${p.name}-${p.program}`);

                // Rule 1: Same program, cheaper country
                const sameProgram = universitiesDatabase.filter(item =>
                    item.program === reference.program &&
                    item.country !== reference.country &&
                    item.tuition < reference.tuitionNum &&
                    !selectedNames.includes(`${item.name}-${item.program}`)
                ).sort((a, b) => a.tuition - b.tuition).slice(0, 2);

                recommendations.push(...sameProgram);

                // Rule 2: Same country, related program (if we need more)
                if (recommendations.length < 3) {
                    const sameCountry = universitiesDatabase.filter(item =>
                        item.country === reference.country &&
                        item.program !== reference.program &&
                        !selectedNames.includes(`${item.name}-${item.program}`)
                    ).slice(0, 3 - recommendations.length);

                    recommendations.push(...sameCountry);
                }

                // Rule 3: Similar budget (if we still need more)
                if (recommendations.length < 3) {
                    const similarBudget = universitiesDatabase.filter(item =>
                        Math.abs(item.tuition - reference.tuitionNum) / reference.tuitionNum <= 0.2 &&
                        item.country !== reference.country &&
                        !selectedNames.includes(`${item.name}-${item.program}`)
                    ).slice(0, 3 - recommendations.length);

                    recommendations.push(...similarBudget);
                }

                // Display recommendations
                const container = document.getElementById('recommendations-list');
                if (recommendations.length > 0) {
                    container.innerHTML = recommendations.slice(0, 3).map(item => `
                        <div class="bg-white rounded-xl p-4 shadow-sm border border-purple-100 card-hover cursor-pointer"
                             onclick="selectProgram('${item.name.replace(/'/g, "\\'")}', '${item.program.replace(/'/g, "\\'")}', '${item.country}', '${item.countryName}', ${item.tuition}, ${item.duration}, ${item.livingCost})">
                            <h4 class="font-bold text-gray-900 text-sm mb-1">${item.name}</h4>
                            <p class="text-xs text-gray-600 mb-2">${item.program}</p>
                            <p class="text-xs text-gray-500 mb-2">${item.countryName}</p>
                            <div class="flex justify-between items-center">
                                <span class="text-sm font-bold text-purple-600">$${item.tuition.toLocaleString()}</span>
                                <button class="text-xs bg-purple-100 text-purple-700 px-2 py-1 rounded hover:bg-purple-200">
                                    + Add
                                </button>
                            </div>
                        </div>
                    `).join('');

                    document.getElementById('smart-recommendations').classList.remove('hidden');
                } else {
                    document.getElementById('smart-recommendations').classList.add('hidden');
                }
            };

            // Remove old search method functions (no longer needed)

            window.onCountrySelected = function () {
                const countryCode = document.getElementById('search-country').value;
                if (!countryCode) return;
                window.selectedCountry = countryCode;
                const countryUnis = [...new Set(universitiesDatabase.filter(u => u.country === countryCode).map(u => u.name))];
                const universitySelect = document.getElementById('search-university');
                if (universitySelect) {
                    universitySelect.innerHTML = '<option value="">Select a university</option>' + countryUnis.map(uni => `<option value="${uni}">${uni}</option>`).join('');
                    document.getElementById('university-field').classList.remove('hidden');
                }
                if (window.searchMethod === 'program' && window.selectedProgram) {
                    filterProgramsByCountryAndProgram();
                }
            };

            window.onUniversitySelected = function () {
                const universityName = document.getElementById('search-university')?.value || document.getElementById('search-university-input')?.value;
                if (!universityName) return;
                window.selectedUniversity = universityName;
                const uniPrograms = [...new Set(universitiesDatabase.filter(u => u.name === universityName).map(u => u.program))];
                const programSelect = document.getElementById('search-program');
                if (programSelect) {
                    programSelect.innerHTML = '<option value="">Select a program</option>' + uniPrograms.map(p => `<option value="${p}">${p}</option>`).join('');
                    document.getElementById('program-field').classList.remove('hidden');
                }
            };

            window.onProgramSelected = function () {
                const programName = document.getElementById('search-program').value;
                if (!programName) return;
                window.selectedProgram = programName;
                if (window.searchMethod === 'country') {
                    showMatchingPrograms();
                } else if (window.searchMethod === 'university') {
                    showMatchingPrograms();
                } else if (window.searchMethod === 'program') {
                    document.getElementById('country-field').classList.remove('hidden');
                }
            };

            window.searchUniversity = function (query) {
                if (query.length < 2) {
                    document.getElementById('university-results').classList.add('hidden');
                    return;
                }
                const filtered = [...new Set(universitiesDatabase.map(u => u.name).filter(name => name.toLowerCase().includes(query.toLowerCase())).slice(0, 10))];
                const resultsDiv = document.getElementById('university-results');
                if (filtered.length === 0) {
                    resultsDiv.innerHTML = '<div class="search-result p-4 text-center text-gray-500">No universities found</div>';
                } else {
                    resultsDiv.innerHTML = filtered.map(uni => `<div class="search-result" onclick="selectUniversityFromSearch('${uni.replace(/'/g, "\\'")}')"><div class="font-bold text-gray-900">${uni}</div></div>`).join('');
                }
                resultsDiv.classList.remove('hidden');
            };

            window.selectUniversityFromSearch = function (uniName) {
                document.getElementById('search-university-input').value = uniName;
                window.selectedUniversity = uniName;
                document.getElementById('university-results').classList.add('hidden');
                onUniversitySelected();
            };

            function filterProgramsByCountryAndProgram() {
                if (!window.selectedCountry || !window.selectedProgram) return;
                const matchingUnis = [...new Set(universitiesDatabase.filter(u => u.country === window.selectedCountry && u.program === window.selectedProgram).map(u => u.name))];
                const universitySelect = document.getElementById('search-university');
                if (universitySelect) {
                    universitySelect.innerHTML = '<option value="">Select a university</option>' + matchingUnis.map(uni => `<option value="${uni}">${uni}</option>`).join('');
                    document.getElementById('university-field').classList.remove('hidden');
                }
            }

            function showMatchingPrograms() {
                let matching = universitiesDatabase;
                if (window.selectedCountry) matching = matching.filter(u => u.country === window.selectedCountry);
                if (window.selectedUniversity) matching = matching.filter(u => u.name === window.selectedUniversity);
                if (window.selectedProgram) matching = matching.filter(u => u.program === window.selectedProgram);

                matching.forEach(program => {
                    if (!window.selectedPrograms.find(p => p.name === program.name && p.program === program.program && p.country === program.country)) {
                        window.selectedPrograms.push({
                            name: program.name,
                            location: `${program.countryName} - ${program.name}`,
                            tuition: `$${program.tuition.toLocaleString()}`,
                            duration: `${program.duration} months`,
                            program: program.program,
                            country: program.country,
                            countryName: program.countryName,
                            livingCost: program.livingCost,
                            tuitionNum: program.tuition,
                            durationNum: program.duration
                        });
                    }
                });

                document.getElementById('emptyState').classList.add('hidden');
                renderSelectedPrograms();
            }

            function removeProgram(index) {
                window.selectedPrograms.splice(index, 1);
                if (window.selectedPrograms.length === 0) {
                    document.getElementById('emptyState').classList.remove('hidden');
                }
                renderSelectedPrograms();
            }

            function renderSelectedPrograms() {
                const container = document.getElementById('selectedPrograms');
                if (window.selectedPrograms.length === 0) {
                    container.innerHTML = '';
                    return;
                }

                let html = window.selectedPrograms.map((program, index) => {
                    // Calculate total 2-year cost estimate
                    const totalCost = (program.tuitionNum + (program.livingCost * program.durationNum)).toLocaleString();
                    const avgSalary = Math.floor(program.tuitionNum * 1.8).toLocaleString(); // Rough estimate

                    return `
        <div class="relative bg-white rounded-lg border-2 border-gray-200 p-6 hover:border-indigo-300 hover:shadow-md transition-all">
            <button class="absolute top-4 right-4 text-gray-400 hover:text-red-500 hover:bg-red-50 rounded-full w-8 h-8 flex items-center justify-center transition-all" onclick="removeProgram(${index})">×</button>
            
            <div class="flex justify-between items-start mb-4 pr-8">
                <div class="flex-1">
                    <div class="flex items-center gap-2 mb-2">
                        <span class="inline-block px-2 py-1 bg-indigo-100 text-indigo-700 text-xs font-semibold rounded">Top Program</span>
                    </div>
                    <h3 class="text-lg font-bold text-gray-900 mb-1">${program.name}</h3>
                    <p class="text-sm text-gray-600">${program.program} • ${program.location}</p>
                </div>
                <div class="text-right">
                    <div class="text-2xl font-bold text-gray-900">$${totalCost}</div>
                    <div class="text-xs text-gray-500">Total ${program.durationNum}-mo cost</div>
                </div>
            </div>
            
            <div class="grid grid-cols-3 gap-4 pt-4 border-t border-gray-100">
                <div>
                    <div class="text-xs text-gray-500 uppercase tracking-wide font-medium mb-1">Duration</div>
                    <div class="text-sm font-semibold text-gray-900">${program.durationNum} months</div>
                </div>
                <div>
                    <div class="text-xs text-gray-500 uppercase tracking-wide font-medium mb-1">Tuition</div>
                    <div class="text-sm font-semibold text-gray-900">$${program.tuitionNum.toLocaleString()}</div>
                </div>
                <div>
                    <div class="text-xs text-gray-500 uppercase tracking-wide font-medium mb-1">Avg Salary</div>
                    <div class="text-sm font-semibold text-emerald-600">$${avgSalary}</div>
                </div>
            </div>
        </div>
        `;
                }).join('');

                // Add "Add Comparison" card if only 1 program selected
                if (window.selectedPrograms.length === 1) {
                    html += `
                        <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 flex flex-col items-center justify-center text-center cursor-pointer hover:border-indigo-500 hover:bg-indigo-50 transition-all group" onclick="document.getElementById('intelligent-search').focus(); document.getElementById('intelligent-search').scrollIntoView({behavior: 'smooth', block: 'center'});">
                            <div class="w-12 h-12 rounded-full bg-gray-100 group-hover:bg-indigo-100 flex items-center justify-center mb-3 transition-colors">
                                <svg class="w-6 h-6 text-gray-400 group-hover:text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                                </svg>
                            </div>
                            <h3 class="font-semibold text-gray-900 group-hover:text-indigo-700 mb-1">Add Program to Compare</h3>
                            <p class="text-xs text-gray-500">Search for another program above</p>
                        </div>
                    `;
                }

                container.innerHTML = html;
                window.removeProgram = removeProgram;
            }

            window.selectSearchMethod = selectSearchMethod;

            window.resetSearchFields = function () {
                // Reset University Search
                const uniInput = document.getElementById('search-university-input');
                if (uniInput) uniInput.value = '';

                const uniResults = document.getElementById('university-results');
                if (uniResults) {
                    uniResults.innerHTML = '';
                    uniResults.classList.add('hidden');
                }

                // Reset Country Search
                const countrySelect = document.getElementById('search-country');
                if (countrySelect) countrySelect.value = '';

                const uniField = document.getElementById('university-field');
                if (uniField) uniField.classList.add('hidden');

                // Reset Program Select (Common)
                const programSelect = document.getElementById('search-program');
                if (programSelect) {
                    programSelect.innerHTML = '<option value="">Select a program</option>';
                }

                const programField = document.getElementById('program-field');
                if (programField) programField.classList.add('hidden');
            }
        </script>

        <!-- Step 2: Funds -->
        <section id="step-2" class="bg-white rounded-xl border border-gray-200 p-8 mb-4 shadow-sm">
            <div class="mb-6">
                <h2 class="text-2xl font-bold text-gray-900 mb-2">Step 2: Your Financial Resources</h2>
                <p class="text-sm text-gray-500">Tell us about your available funds and financial support</p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                        Current Savings
                        <span class="text-gray-400 font-normal ml-1">(USD)</span>
                    </label>
                    <div class="flex items-center border-2 border-gray-200 rounded-lg focus-within:border-indigo-500 focus-within:ring-4 focus-within:ring-indigo-100 transition-all bg-white">
                        <span class="pl-4 pr-2 text-gray-500 font-medium">$</span>
                        <input type="number" id="input-savings" placeholder="0"
                            class="flex-1 py-3 pr-4 border-0 focus:outline-none focus:ring-0 bg-transparent" />
                    </div>
                    <p class="text-xs text-gray-500 mt-1">Liquid assets you have available now</p>
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                        Family Support
                        <span class="text-gray-400 font-normal ml-1">(USD)</span>
                    </label>
                    <div class="flex items-center border-2 border-gray-200 rounded-lg focus-within:border-indigo-500 focus-within:ring-4 focus-within:ring-indigo-100 transition-all bg-white">
                        <span class="pl-4 pr-2 text-gray-500 font-medium">$</span>
                        <input type="number" id="input-family" placeholder="0"
                            class="flex-1 py-3 pr-4 border-0 focus:outline-none focus:ring-0 bg-transparent" />
                    </div>
                    <p class="text-xs text-gray-500 mt-1">Financial support from family members</p>
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                        Scholarships & Grants
                        <span class="text-gray-400 font-normal ml-1">(USD)</span>
                    </label>
                    <div class="flex items-center border-2 border-gray-200 rounded-lg focus-within:border-indigo-500 focus-within:ring-4 focus-within:ring-indigo-100 transition-all bg-white">
                        <span class="pl-4 pr-2 text-gray-500 font-medium">$</span>
                        <input type="number" id="input-scholarships" placeholder="0"
                            class="flex-1 py-3 pr-4 border-0 focus:outline-none focus:ring-0 bg-transparent" />
                    </div>
                    <p class="text-xs text-gray-500 mt-1">Confirmed scholarships or grants</p>
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                        Loans
                        <span class="text-gray-400 font-normal ml-1">(USD)</span>
                    </label>
                    <div class="flex items-center border-2 border-gray-200 rounded-lg focus-within:border-indigo-500 focus-within:ring-4 focus-within:ring-indigo-100 transition-all bg-white">
                        <span class="pl-4 pr-2 text-gray-500 font-medium">$</span>
                        <input type="number" id="input-loans" placeholder="0"
                            class="flex-1 py-3 pr-4 border-0 focus:outline-none focus:ring-0 bg-transparent" />
                    </div>
                    <p class="text-xs text-gray-500 mt-1">Student loans you can access</p>
                </div>
            </div>
        </section>

        <!-- Step 3: Hidden Costs (One-time & Annual) -->
        <!-- Step 3: Hidden Costs -->
        <section id="step-3" class="bg-white rounded-xl border border-gray-200 p-8 mb-4 shadow-sm">
            <div class="mb-6">
                <h2 class="text-2xl font-bold text-gray-900 mb-2">Step 3: One-Time & Hidden Costs</h2>
                <p class="text-sm text-gray-500">Account for expenses beyond tuition and monthly living costs</p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                        Visa & Immigration Fees
                        <span class="text-gray-400 font-normal ml-1">(USD)</span>
                    </label>
                    <div class="flex items-center border-2 border-gray-200 rounded-lg focus-within:border-indigo-500 focus-within:ring-4 focus-within:ring-indigo-100 transition-all bg-white">
                        <span class="pl-4 pr-2 text-gray-500 font-medium">$</span>
                        <input type="number" id="input-visa" placeholder="500"
                            class="flex-1 py-3 pr-4 border-0 focus:outline-none focus:ring-0 bg-transparent" />
                    </div>
                    <p class="text-xs text-gray-500 mt-1">Typical range: $300-$800</p>
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                        Health Insurance
                        <span class="text-gray-400 font-normal ml-1">(Annual, USD)</span>
                    </label>
                    <div class="flex items-center border-2 border-gray-200 rounded-lg focus-within:border-indigo-500 focus-within:ring-4 focus-within:ring-indigo-100 transition-all bg-white">
                        <span class="pl-4 pr-2 text-gray-500 font-medium">$</span>
                        <input type="number" id="input-insurance" placeholder="2000"
                            class="flex-1 py-3 pr-4 border-0 focus:outline-none focus:ring-0 bg-transparent" />
                    </div>
                    <p class="text-xs text-gray-500 mt-1">If not included in tuition</p>
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                        Accommodation Deposit
                        <span class="text-gray-400 font-normal ml-1">(USD)</span>
                    </label>
                    <div class="flex items-center border-2 border-gray-200 rounded-lg focus-within:border-indigo-500 focus-within:ring-4 focus-within:ring-indigo-100 transition-all bg-white">
                        <span class="pl-4 pr-2 text-gray-500 font-medium">$</span>
                        <input type="number" id="input-deposit" placeholder="1000"
                            class="flex-1 py-3 pr-4 border-0 focus:outline-none focus:ring-0 bg-transparent" />
                    </div>
                    <p class="text-xs text-gray-500 mt-1">First/last month rent</p>
                </div>
            </div>
        </section>

        <!-- Step 4: Lifestyle -->
        <section id="step-4" class="bg-white rounded-2xl border border-gray-200 p-5 mb-4 shadow-sm">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-900">Step 4: Define Your Lifestyle</h2>

                <!-- Monthly/Semester Toggle -->
                <div class="flex items-center bg-gray-100 rounded-lg p-1">
                    <button id="toggle-monthly" onclick="toggleLifestyleMode('monthly')"
                        class="px-4 py-2 rounded-md text-sm font-semibold bg-white shadow-sm text-indigo-600 transition-all">Monthly</button>
                    <button id="toggle-semester" onclick="toggleLifestyleMode('semester')"
                        class="px-4 py-2 rounded-md text-sm font-semibold text-gray-500 hover:text-gray-700 transition-all">Semester</button>
                </div>
            </div>
            <p class="text-gray-600 mb-6 text-center" id="lifestyle-subtitle">Break down your monthly expenses by
                category</p>

            <!-- Interactive Lifestyle Calculator -->
            <div class="bg-gradient-to-br from-indigo-50 to-purple-50 rounded-2xl border-2 border-indigo-200 p-5">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <!-- Food & Dining -->
                    <div class="bg-white rounded-xl p-5 shadow-sm">
                        <div class="flex justify-between items-center mb-3">
                            <label class="font-semibold text-gray-900 flex items-center">
                                <span class="text-2xl mr-2">🍔</span>
                                Food & Dining
                            </label>
                            <span class="text-xl font-bold text-indigo-600" id="food-value">$400</span>
                        </div>
                        <input type="range" id="food-slider" min="200" max="800" value="400" step="50"
                            class="w-full h-2 bg-indigo-200 rounded-lg appearance-none cursor-pointer slider"
                            oninput="updateLifestyleCategory('food', this.value)">
                        <div class="flex justify-between text-xs text-gray-500 mt-1">
                            <span>$200</span>
                            <span>$800</span>
                        </div>
                    </div>

                    <!-- Transportation -->
                    <div class="bg-white rounded-xl p-5 shadow-sm">
                        <div class="flex justify-between items-center mb-3">
                            <label class="font-semibold text-gray-900 flex items-center">
                                <span class="text-2xl mr-2">🚇</span>
                                Transportation
                            </label>
                            <span class="text-xl font-bold text-indigo-600" id="transport-value">$100</span>
                        </div>
                        <input type="range" id="transport-slider" min="50" max="300" value="100" step="25"
                            class="w-full h-2 bg-indigo-200 rounded-lg appearance-none cursor-pointer slider"
                            oninput="updateLifestyleCategory('transport', this.value)">
                        <div class="flex justify-between text-xs text-gray-500 mt-1">
                            <span>$50</span>
                            <span>$300</span>
                        </div>
                    </div>

                    <!-- Housing Extras -->
                    <div class="bg-white rounded-xl p-5 shadow-sm">
                        <div class="flex justify-between items-center mb-3">
                            <label class="font-semibold text-gray-900 flex items-center">
                                <span class="text-2xl mr-2">🏠</span>
                                Housing Extras
                            </label>
                            <span class="text-xl font-bold text-indigo-600" id="housing-value">$200</span>
                        </div>
                        <input type="range" id="housing-slider" min="100" max="500" value="200" step="50"
                            class="w-full h-2 bg-indigo-200 rounded-lg appearance-none cursor-pointer slider"
                            oninput="updateLifestyleCategory('housing', this.value)">
                        <div class="flex justify-between text-xs text-gray-500 mt-1">
                            <span>$100</span>
                            <span>$500</span>
                        </div>
                        <p class="text-xs text-gray-500 mt-1">Utilities, internet, etc.</p>
                    </div>

                    <!-- Entertainment -->
                    <div class="bg-white rounded-xl p-5 shadow-sm">
                        <div class="flex justify-between items-center mb-3">
                            <label class="font-semibold text-gray-900 flex items-center">
                                <span class="text-2xl mr-2">🎭</span>
                                Entertainment
                            </label>
                            <span class="text-xl font-bold text-indigo-600" id="entertainment-value">$150</span>
                        </div>
                        <input type="range" id="entertainment-slider" min="50" max="400" value="150" step="25"
                            class="w-full h-2 bg-indigo-200 rounded-lg appearance-none cursor-pointer slider"
                            oninput="updateLifestyleCategory('entertainment', this.value)">
                        <div class="flex justify-between text-xs text-gray-500 mt-1">
                            <span>$50</span>
                            <span>$400</span>
                        </div>
                    </div>

                    <!-- Phone & Internet -->
                    <div class="bg-white rounded-xl p-5 shadow-sm">
                        <div class="flex justify-between items-center mb-3">
                            <label class="font-semibold text-gray-900 flex items-center">
                                <span class="text-2xl mr-2">📱</span>
                                Phone & Internet
                            </label>
                            <span class="text-xl font-bold text-indigo-600" id="phone-value">$50</span>
                        </div>
                        <input type="range" id="phone-slider" min="30" max="150" value="50" step="10"
                            class="w-full h-2 bg-indigo-200 rounded-lg appearance-none cursor-pointer slider"
                            oninput="updateLifestyleCategory('phone', this.value)">
                        <div class="flex justify-between text-xs text-gray-500 mt-1">
                            <span>$30</span>
                            <span>$150</span>
                        </div>
                    </div>

                    <!-- Personal Care -->
                    <div class="bg-white rounded-xl p-5 shadow-sm">
                        <div class="flex justify-between items-center mb-3">
                            <label class="font-semibold text-gray-900 flex items-center">
                                <span class="text-2xl mr-2">💇</span>
                                Personal Care
                            </label>
                            <span class="text-xl font-bold text-indigo-600" id="personal-value">$100</span>
                        </div>
                        <input type="range" id="personal-slider" min="50" max="250" value="100" step="25"
                            class="w-full h-2 bg-indigo-200 rounded-lg appearance-none cursor-pointer slider"
                            oninput="updateLifestyleCategory('personal', this.value)">
                        <div class="flex justify-between text-xs text-gray-500 mt-1">
                            <span>$50</span>
                            <span>$250</span>
                        </div>
                    </div>
                </div>

                <!-- Total Display -->
                <div class="bg-white rounded-2xl border-2 border-indigo-300 p-6 text-center">
                    <p class="text-sm text-gray-600 mb-2">Your Monthly Living Cost</p>
                    <div class="text-5xl font-bold text-indigo-600 mb-2" id="lifestyle-total">$1,000</div>
                    <div class="flex items-center justify-center gap-4 text-sm">
                        <span class="text-gray-500">Country average: <span id="country-baseline">$1,000</span></span>
                        <span id="lifestyle-comparison" class="font-semibold text-green-600">Within budget</span>
                    </div>
                    <div class="mt-4 flex gap-2 justify-center flex-wrap">
                        <button onclick="setLifestylePreset(900, this)"
                            class="bg-white border-2 border-gray-200 text-gray-700 px-4 py-3 rounded-lg font-medium hover:border-indigo-500 hover:bg-indigo-50 transition-all">
                            Frugal - $900/mo
                        </button>
                        <button onclick="setLifestylePreset(1400, this)"
                            class="bg-white border-2 border-gray-200 text-gray-700 px-4 py-3 rounded-lg font-medium hover:border-indigo-500 hover:bg-indigo-50 transition-all">
                            Balanced - $1,400/mo
                        </button>
                        <button onclick="setLifestylePreset(2100, this)"
                            class="bg-white border-2 border-gray-200 text-gray-700 px-4 py-3 rounded-lg font-medium hover:border-indigo-500 hover:bg-indigo-50 transition-all">
                            Comfortable - $2,100/mo
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Step 5: Income -->
        <section id="step-5" class="bg-white rounded-2xl border border-gray-200 p-5 mb-4 shadow-sm">
            <h2 class="text-2xl font-bold text-gray-900 mb-6">Step 5: Will You Have Additional Income?</h2>

            <div class="space-y-8">
                <!-- Home Country Salary -->
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-4">Will you maintain your salary from
                        your home country?</label>
                    <div class="grid grid-cols-2 gap-4">
                        <div onclick="selectSalary('yes', this)"
                            class="bg-white border-2 border-gray-200 rounded-lg p-6 text-center cursor-pointer hover:border-indigo-500 hover:bg-indigo-50 transition-all">
                            <div class="text-lg font-semibold text-gray-900">Yes</div>
                            <div class="text-sm text-gray-500 mt-1">I'll have income</div>
                        </div>
                        <div onclick="selectSalary('no', this)"
                            class="bg-white border-2 border-indigo-500 rounded-lg p-6 text-center cursor-pointer hover:border-indigo-500 hover:bg-indigo-50 transition-all bg-indigo-50">
                            <div class="text-lg font-semibold text-gray-900">No</div>
                            <div class="text-sm text-gray-500 mt-1">No income during studies</div>
                        </div>
                    </div>
                </div>
                <div id="salary-amount-group" class="hidden">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Monthly Salary from Home Country
                        ($)</label>
                    <input type="text" id="input-home-salary" placeholder="Enter monthly amount in USD" />
                </div>

                <!-- On-Campus Job -->
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-4">Will you have an on-campus
                        job?</label>
                    <div class="grid grid-cols-2 gap-4">
                        <div onclick="selectOnCampus('yes', this)"
                            class="bg-white border-2 border-gray-200 rounded-lg p-6 text-center cursor-pointer hover:border-indigo-500 hover:bg-indigo-50 transition-all">
                            <div class="text-lg font-semibold text-gray-900">Yes</div>
                            <div class="text-sm text-gray-500 mt-1">I'll work on campus</div>
                        </div>
                        <div onclick="selectOnCampus('no', this)"
                            class="bg-white border-2 border-indigo-500 rounded-lg p-6 text-center cursor-pointer hover:border-indigo-500 hover:bg-indigo-50 transition-all bg-indigo-50">
                            <div class="text-lg font-semibold text-gray-900">No</div>
                            <div class="text-sm text-gray-500 mt-1">No on-campus job</div>
                        </div>
                    </div>
                </div>
                <div id="oncampus-details-group" class="hidden space-y-4">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Hours per Week (max 20)</label>
                        <input type="number" id="input-hours-week" min="0" max="20" placeholder="Max 20 hours/week" />
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Hourly Rate ($)</label>
                        <input type="text" id="input-hourly-rate" placeholder="Enter rate per hour" />
                    </div>
                </div>
            </div>
        </section>

        <script>
            window.selectedSalary = 'no';
            window.selectedOnCampus = 'no';

            function selectSalary(type, element) {
                const salarySection = element.closest('.grid'); // Target the grid containing the cards
                if (salarySection) {
                    // Remove selected state from all cards
                    salarySection.querySelectorAll('[onclick^="selectSalary"]').forEach(card => {
                        card.classList.remove('border-indigo-500', 'bg-indigo-50');
                        card.classList.add('border-gray-200');
                    });
                }
                // Add selected state to clicked card
                element.classList.remove('border-gray-200');
                element.classList.add('border-indigo-500', 'bg-indigo-50');
                window.selectedSalary = type;
                document.getElementById('salary-amount-group').classList.toggle('hidden', type !== 'yes');
            }

            function selectOnCampus(type, element) {
                const oncampusSection = element.closest('.grid'); // Target the grid containing the cards
                if (oncampusSection) {
                    // Remove selected state from all cards
                    oncampusSection.querySelectorAll('[onclick^="selectOnCampus"]').forEach(card => {
                        card.classList.remove('border-indigo-500', 'bg-indigo-50');
                        card.classList.add('border-gray-200');
                    });
                }
                // Add selected state to clicked card
                element.classList.remove('border-gray-200');
                element.classList.add('border-indigo-500', 'bg-indigo-50');
                window.selectedOnCampus = type;
                document.getElementById('oncampus-details-group').classList.toggle('hidden', type !== 'yes');
            }

            function selectLifestyle(type, element) {
                const lifestyleSection = element.closest('section');
                if (lifestyleSection) {
                    lifestyleSection.querySelectorAll('.card-selectable').forEach(card => {
                        card.classList.remove('selected');
                    });
                }
                element.classList.add('selected');
                window.selectedLifestyle = type;
            }

            window.lifestyleMode = 'monthly'; // 'monthly' or 'semester'

            function toggleLifestyleMode(mode) {
                window.lifestyleMode = mode;
                const monthlyBtn = document.getElementById('toggle-monthly');
                const semesterBtn = document.getElementById('toggle-semester');
                const subtitle = document.getElementById('lifestyle-subtitle');

                if (mode === 'monthly') {
                    monthlyBtn.classList.add('bg-white', 'shadow-sm', 'text-indigo-600');
                    monthlyBtn.classList.remove('text-gray-500');
                    semesterBtn.classList.remove('bg-white', 'shadow-sm', 'text-indigo-600');
                    semesterBtn.classList.add('text-gray-500');
                    subtitle.textContent = 'How do you plan to live during your studies? (Monthly estimate)';
                } else {
                    semesterBtn.classList.add('bg-white', 'shadow-sm', 'text-indigo-600');
                    semesterBtn.classList.remove('text-gray-500');
                    monthlyBtn.classList.remove('bg-white', 'shadow-sm', 'text-indigo-600');
                    monthlyBtn.classList.add('text-gray-500');
                    subtitle.textContent = 'How do you plan to live during your studies? (Semester estimate)';
                }
            }

            // New Lifestyle Calculator Functions
            window.lifestyleCategories = {
                food: 400,
                transport: 100,
                housing: 200,
                entertainment: 150,
                phone: 50,
                personal: 100
            };

            window.updateLifestyleCategory = function (category, value) {
                value = parseInt(value);
                window.lifestyleCategories[category] = value;

                // Update display
                document.getElementById(`${category}-value`).textContent = `$${value}`;

                // Calculate total
                const total = Object.values(window.lifestyleCategories).reduce((sum, val) => sum + val, 0);
                document.getElementById('lifestyle-total').textContent = `$${total.toLocaleString()}`;

                // Update comparison with country baseline
                const baseline = parseInt(document.getElementById('country-baseline').textContent.replace(/[$,]/g, '')) || 1000;
                const comparison = document.getElementById('lifestyle-comparison');
                const diff = total - baseline;

                if (diff < 0) {
                    comparison.textContent = 'Within budget';
                    comparison.className = 'font-semibold text-green-600';
                } else if (diff < 200) {
                    comparison.textContent = 'Slightly over';
                    comparison.className = 'font-semibold text-yellow-600';
                } else {
                    comparison.textContent = 'Above average';
                    comparison.className = 'font-semibold text-red-600';
                }
            };

            window.setLifestylePreset = function (preset) {
                const presets = {
                    frugal: { food: 300, transport: 75, housing: 150, entertainment: 75, phone: 40, personal: 60 },
                    balanced: { food: 450, transport: 125, housing: 250, entertainment: 175, phone: 60, personal: 125 },
                    comfortable: { food: 650, transport: 200, housing: 400, entertainment: 300, phone: 100, personal: 200 }
                };

                const values = presets[preset];
                if (!values) return;

                // Update all sliders and values
                Object.keys(values).forEach(category => {
                    const slider = document.getElementById(`${category}-slider`);
                    if (slider) {
                        slider.value = values[category];
                        window.updateLifestyleCategory(category, values[category]);
                    }
                });
            };

            // Initialize lifestyle calculator on load
            document.addEventListener('DOMContentLoaded', () => {
                // Set initial total
                const initialTotal = Object.values(window.lifestyleCategories).reduce((sum, val) => sum + val, 0);
                document.getElementById('lifestyle-total').textContent = `$${initialTotal.toLocaleString()}`;
            });

            function calculatePlan() {
                const programs = window.selectedPrograms || [];
                if (programs.length === 0) {
                    alert('Please select at least one university');
                    return;
                }

                // Helper function to safely get input value
                function getInputValue(id, defaultValue = 0) {
                    const element = document.getElementById(id);
                    return element ? (parseFloat(element.value) || defaultValue) : defaultValue;
                }

                const savings = getInputValue('input-savings', 0);
                const family = getInputValue('input-family', 0);
                const scholarships = getInputValue('input-scholarships', 0);

                // Hidden Costs - flights field doesn't exist, so default to 0
                const flights = 0; // No flights input field in current HTML
                const visa = getInputValue('input-visa', 0);
                const insurance = getInputValue('input-insurance', 0);
                const deposit = getInputValue('input-deposit', 0);

                const lifestyle = window.selectedLifestyle || 'balanced';
                const lifestyleMap = {
                    'frugal': 900,
                    'balanced': 1400,
                    'comfortable': 2100
                };

                let baseMonthlyLiving = lifestyleMap[lifestyle] || 1400;

                const hasHomeSalary = window.selectedSalary === 'yes';
                const homeSalaryMonthly = hasHomeSalary ? getInputValue('input-home-salary', 0) : 0;

                const hasOnCampusJob = window.selectedOnCampus === 'yes';
                const hoursPerWeek = hasOnCampusJob ? getInputValue('input-hours-week', 0) : 0;
                const hourlyRate = hasOnCampusJob ? getInputValue('input-hourly-rate', 0) : 0;
                const monthlyOnCampusIncome = hoursPerWeek * hourlyRate * 4;

                const totalMonthlyIncome = homeSalaryMonthly + monthlyOnCampusIncome;

                // One-time expenses
                const oneTimeExpenses = flights + visa + deposit;
                const totalPersonalFunds = savings + family + scholarships;

                if (programs.length === 2) {
                    // Comparison Mode
                    const p1 = programs[0];
                    const p2 = programs[1];

                    // Helper to calc cost for a program
                    const calcCost = (prog) => {
                        const t = prog.tuitionNum || parseInt(prog.tuition.replace('$', '').replace(/,/g, '')) || 0;
                        const d = prog.durationNum || parseInt(prog.duration.replace(' months', '').replace(' month', '')) || 12;
                        const lc = prog.livingCost || baseMonthlyLiving;
                        let adjLc = lc;
                        if (lifestyle === 'frugal') adjLc = lc * 0.8;
                        if (lifestyle === 'comfortable') adjLc = lc * 1.4;

                        const totalL = adjLc * d;
                        const recAnn = insurance * (d / 12);
                        return {
                            tuition: t,
                            living: totalL,
                            cost: t + totalL + oneTimeExpenses + recAnn,
                            duration: d
                        };
                    };

                    const c1 = calcCost(p1);
                    const c2 = calcCost(p2);

                    const gap1 = c1.cost - totalPersonalFunds;
                    const gap2 = c2.cost - totalPersonalFunds;

                    const params = new URLSearchParams({
                        simType: 'compare',
                        // Program A
                        nameA: p1.program ? `${p1.name} - ${p1.program}` : p1.name,
                        tuitionA: c1.tuition,
                        livingA: c1.living,
                        costA: c1.cost,
                        gapA: gap1,
                        // Program B
                        nameB: p2.program ? `${p2.name} - ${p2.program}` : p2.name,
                        tuitionB: c2.tuition,
                        livingB: c2.living,
                        costB: c2.cost,
                        gapB: gap2,
                        // Shared
                        savings: savings,
                        family: family,
                        scholarships: scholarships,
                        lifestyle: lifestyle,
                        monthlyLiving: baseMonthlyLiving, // Approx
                        duration: c1.duration, // Use A's duration for charts? Or max? Results.html might need update for this.
                        hasHomeSalary: hasHomeSalary,
                        homeSalaryMonthly: homeSalaryMonthly,
                        hasOnCampusJob: hasOnCampusJob,
                        hoursPerWeek: hoursPerWeek,
                        hourlyRate: hourlyRate,
                        monthlyOnCampusIncome: monthlyOnCampusIncome,
                        totalMonthlyIncome: totalMonthlyIncome,
                        flights: flights,
                        visa: visa,
                        insurance: insurance,
                        deposit: deposit,
                        oneTimeExpenses: oneTimeExpenses
                    });
                    window.location.href = `results.html?${params.toString()}`;
                    return;
                }

                const program = programs[0];
                // Use tuitionNum and durationNum if available, otherwise parse from strings
                const tuition = program.tuitionNum || parseInt(program.tuition.replace('$', '').replace(/,/g, '')) || 0;
                const durationMonths = program.durationNum || parseInt(program.duration.replace(' months', '').replace(' month', '')) || 12;

                // Use country living cost if available, otherwise use lifestyle estimate
                const countryLivingCost = program.livingCost || baseMonthlyLiving;

                // Adjust living cost based on country and lifestyle choice
                // If user chose a lifestyle, we scale the country's base cost
                // Frugal = 0.8 * country base, Balanced = 1.0 * country base, Comfortable = 1.4 * country base
                let adjustedMonthlyLiving = countryLivingCost;
                if (lifestyle === 'frugal') adjustedMonthlyLiving = countryLivingCost * 0.8;
                if (lifestyle === 'comfortable') adjustedMonthlyLiving = countryLivingCost * 1.4;

                // If input mode is semester, we need to interpret the "lifestyle" selection differently or just use the logic above
                // The requirement says: "Toggle Semestral/Mensual: En el paso de 'Lifestyle', añadir un toggle switch que permita al usuario ingresar sus costos de vida 'Por Mes' o 'Por Semestre'."
                // But the UI currently has cards for Frugal/Balanced/Comfortable which are presets.
                // The requirement implies manual input or re-interpreting the presets.
                // Let's assume the presets scale. If "Semester" is selected, we display/treat the values as semesterly?
                // Actually, the requirement says "permit al usuario ingresar". But there is no input field for custom living cost in the current UI, only cards.
                // I will assume the toggle just changes how the calculation is done (visual feedback) or if there was a custom input (which I don't see in the code I read).
                // Wait, looking at the code, there are NO input fields for living cost, just cards.
                // So the toggle is likely for the USER MENTAL MODEL.
                // If I select "Semester", the calculation should probably just display semester costs?
                // The requirement says:
                // if (inputMode === 'semester') {
                //    totalLiving = (inputSemesterCost / 6) * durationMonths;
                // } else {
                //    totalLiving = inputMonthlyCost * durationMonths;
                // }
                // Since we don't have a manual input, I will assume the cards represent the cost for that period.
                // BUT the cards say "Estimated ~$900/mo".
                // I should probably update the card text when toggling?
                // For now, I will stick to the logic:
                // If mode is semester, we assume the user MIGHT have entered a semester cost if there was an input.
                // But since there isn't, I will just calculate totalLiving based on monthly logic, but I need to handle the "Hidden Costs" logic properly.

                // Re-reading requirement: "Toggle Semestral/Mensual: En el paso de 'Lifestyle', añadir un toggle switch que permita al usuario ingresar sus costos de vida 'Por Mes' o 'Por Semestre'."
                // Since there is no input, I will assume the user wants to SEE the costs in that format?
                // OR maybe I should add an input field for "Custom Amount"?
                // The current UI only has cards.
                // I will proceed with the calculation logic as requested:

                // One-time expenses

                // Recurring annual expenses (insurance)
                // Insurance is usually annual. If course is > 12 months, do we multiply?
                // Requirement: "recurringAnnual = insurance * (duration / 12);"
                const recurringAnnual = insurance * (durationMonths / 12);

                const totalLiving = adjustedMonthlyLiving * durationMonths;
                const totalTuition = tuition;
                const totalCost = totalTuition + totalLiving + oneTimeExpenses + recurringAnnual;
                const fundingGap = totalCost - totalPersonalFunds;



                const urlParams = new URLSearchParams(window.location.search);
                const isCompareMode = urlParams.get('mode') === 'compare';

                let params;

                if (isCompareMode) {
                    const storedParamsString = sessionStorage.getItem('compare_program_a');
                    if (!storedParamsString) {
                        alert('Error: No first program found to compare with. Starting over.');
                        window.location.href = 'simulator.html';
                        return;
                    }

                    const storedParams = new URLSearchParams(storedParamsString);

                    // Construct comparison params
                    params = new URLSearchParams();
                    params.append('simType', 'compare');

                    // Program A params (from storage)
                    storedParams.forEach((value, key) => {
                        params.append(key, value);
                    });

                    // Program B params (current calculation)
                    const programBName = program.program ? `${program.name} - ${program.program}` : program.name;
                    params.append('nameB', programBName);
                    params.append('tuitionB', tuition);
                    params.append('livingB', totalLiving);
                    params.append('costB', totalCost);
                    params.append('gapB', fundingGap);
                    // We don't need to pass funds B as they are shared, but results.html might expect them or we just use A's funds as shared funds.
                    // The comparison view in results.html uses personalFundsA and personalFundsB calculated from cost - gap.

                } else {
                    const programName = program.program ? `${program.name} - ${program.program}` : program.name;
                    params = new URLSearchParams({
                        simType: 'single',
                        nameA: programName,
                        tuitionA: tuition,
                        livingA: totalLiving,
                        costA: totalCost,
                        gapA: fundingGap,
                        savings: savings,
                        family: family,
                        scholarships: scholarships,
                        lifestyle: lifestyle,
                        monthlyLiving: adjustedMonthlyLiving,
                        duration: durationMonths,
                        hasHomeSalary: hasHomeSalary,
                        homeSalaryMonthly: homeSalaryMonthly,
                        hasOnCampusJob: hasOnCampusJob,
                        hoursPerWeek: hoursPerWeek,
                        hourlyRate: hourlyRate,
                        monthlyOnCampusIncome: monthlyOnCampusIncome,
                        totalMonthlyIncome: totalMonthlyIncome,
                        // New params
                        flights: flights,
                        visa: visa,
                        insurance: insurance,
                        deposit: deposit,
                        oneTimeExpenses: oneTimeExpenses,
                        recurringAnnual: recurringAnnual
                    });
                }

                window.location.href = `results.html?${params.toString()}`;
            }
        </script>

        <!-- Final CTA -->
        <div class="text-center">
            <button type="button" onclick="calculatePlan()" class="btn btn-primary btn-block">
                Calculate My Plan
            </button>
        </div>
    </main>
</body>

</html>
```