<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Results Dashboard - MasterPlan</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="design-tokens.css">
    <link rel="stylesheet" href="components/components.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap"
        rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }

        h1 {
            font-family: 'Plus Jakarta Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }

        body {
            background: linear-gradient(to bottom, #fafbfc 0%, #ffffff 100%);
        }

        .gradient-text {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        /* Semantic colors for financial data */
        .gradient-deficit {
            background: linear-gradient(135deg, #DC2626 0%, #991B1B 100%);
        }

        .gradient-surplus {
            background: linear-gradient(135deg, #10B981 0%, #059669 100%);
        }

        /* Hero card animations */
        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes pulse {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.02);
            }
        }

        .animate-slideInUp {
            animation: slideInUp 0.6s ease-out;
        }

        .animate-pulse-subtle {
            animation: pulse 2s ease-in-out infinite;
        }

        .sidebar-label {
            font-weight: 600;
            margin-bottom: 0.5rem;
            display: block;
            font-size: 0.75rem;
            /* Reduced from 0.875rem */
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #6B7280;
            /* gray-500 */
        }

        .sidebar-input,
        .sidebar-select {
            border: 2px solid #e5e7eb;
            padding: 0.625rem 0.875rem;
            width: 100%;
            font-size: 0.875rem;
            /* Reduced from 0.9375rem */
            border-radius: 0.5rem;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .sidebar-input:focus,
        .sidebar-select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
            /* Thicker ring */
            transform: translateY(-1px);
            /* Subtle lift */
        }

        /* Collapsible Sidebar */
        .sidebar-collapsed {
            transform: translateX(100%);
            opacity: 0;
            pointer-events: none;
        }

        .sidebar-toggle {
            position: fixed;
            right: 1rem;
            top: 50%;
            transform: translateY(-50%);
            z-index: 40;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Border accents based on state */
        .card-surplus {
            border-left: 4px solid #10B981;
            /* green-500 */
        }

        .card-deficit {
            border-left: 4px solid #EF4444;
            /* red-500 */
        }

        .card-neutral {
            border-left: 4px solid #6366F1;
            /* indigo-500 */
        }

        .hidden-view {
            display: none;
        }

        /* Hover states for better UX */
        .card-hover {
            transition: all 0.3s ease;
        }

        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
    </style>
    <!-- Hotjar Tracking Code for https://masterplan-92uay74xk-sebbs21s-projects.vercel.app/ -->
    <script type="module">
        import Hotjar from './js/hotjar.js';
        const siteId = 6573027;
        const hotjarVersion = 6;
        Hotjar.init(siteId, hotjarVersion);
    </script>
</head>

<body class="antialiased">
    <!-- Navigation -->
    <nav class="bg-white/80 backdrop-blur-md border-b border-gray-100 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-6 py-4">
            <div class="flex justify-between items-center">
                <a href="index.html" class="flex items-center gap-2">
                    <!-- Logo SVG -->
                    <div class="w-8 h-8">
                        <svg viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M20 35 L35 27 L35 65 L20 73 Z" fill="#3730A3"/>
                            <path d="M20 35 L35 27 L50 35 L35 43 Z" fill="#6366F1"/>
                            <path d="M35 43 L50 35 L50 55 L35 63 Z" fill="#D1D5DB"/>
                            <path d="M35 43 L50 35 L65 43 L50 51 Z" fill="#E5E7EB"/>
                            <path d="M65 43 L80 35 L80 73 L65 81 Z" fill="#6366F1"/>
                            <path d="M65 43 L80 35 L65 27 L50 35 Z" fill="#818CF8"/>
                            <path d="M35 63 L50 55 L50 73 L35 81 Z" fill="#9CA3AF"/>
                            <path d="M50 55 L65 47 L65 81 L50 73 Z" fill="#A5B4FC"/>
                            <path d="M20 73 L35 65 L35 81 Z" fill="#4338CA"/>
                            <path d="M65 81 L80 73 L65 65 Z" fill="#4F46E5"/>
                        </svg>
                    </div>
                    <!-- Text -->
                    <span class="text-2xl font-bold gradient-text">MasterPlan</span>
                </a>
                <div class="hidden md:flex items-center space-x-8">
                    <a href="dashboard.html"
                        class="text-gray-700 hover:text-gray-900 font-medium transition-colors">Dashboard</a>
                    <a href="simulator.html"
                        class="text-gray-700 hover:text-gray-900 font-medium transition-colors">Simulator</a>
                    <a href="pricing.html"
                        class="text-gray-700 hover:text-gray-900 font-medium transition-colors">Pricing</a>
                    <div id="user-profile-section" class="flex items-center space-x-3">
                        <!-- User profile will be populated by auth-state.js -->
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-6 py-8">
        <div class="lg:grid lg:grid-cols-4 gap-4">
            <!-- Sidebar Controls -->
            <div id="sidebar-column" class="lg:col-span-1">
                <div class="mb-4 flex items-center justify-between gap-2">
                    <button id="sidebar-toggle"
                        class="flex items-center gap-2 text-gray-600 hover:text-indigo-600 font-medium transition-colors"
                        onclick="toggleSidebar()">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M4 6h16M4 12h16M4 18h16"></path>
                        </svg>
                        <span>Show Filters</span>
                    </button>
                    <!-- Back to Comparison Button (only shown when coming from comparison) -->
                    <button id="back-to-comparison-btn" onclick="showCompareView()"
                        class="hidden bg-white border border-gray-200 text-gray-700 px-4 py-2 rounded-lg font-semibold hover:border-gray-300 hover:shadow-md transition-all flex items-center gap-2 text-sm">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                        </svg>
                        Back to Comparison
                    </button>
                </div>
                <aside id="sidebar-controls" class="space-y-6 hidden lg:block">
                    <!-- Program Costs (Read-only) -->
                    <div class="bg-gray-50 rounded-lg border border-gray-200 p-5 shadow-sm">
                        <h3 class="text-lg font-bold text-gray-900 mb-4">Program Costs</h3>
                        <p class="text-xs text-gray-500 mb-4">These values come from your selected program</p>
                        <div class="space-y-4">
                            <div>
                                <label for="input-tuition" class="sidebar-label">Total Tuition ($)</label>
                                <input type="number" id="input-tuition" class="sidebar-input bg-gray-100 text-gray-600 cursor-not-allowed" value="45000" readonly>
                            </div>
                            <div>
                                <label for="input-duration" class="sidebar-label">Duration (Months)</label>
                                <input type="number" id="input-duration" class="sidebar-input bg-gray-100 text-gray-600 cursor-not-allowed" value="24" readonly>
                            </div>
                        </div>
                    </div>

                    <!-- Your Funds -->
                    <div class="bg-white rounded-lg border border-gray-200 p-5 shadow-sm">
                        <h3 class="text-lg font-bold text-gray-900 mb-4">Your Funds</h3>
                        <div class="space-y-4">
                            <div>
                                <label for="input-savings" class="sidebar-label">Current Savings ($)</label>
                                <input type="number" id="input-savings" class="sidebar-input" value="5000">
                            </div>
                            <div>
                                <label for="input-family" class="sidebar-label">Family Support ($)</label>
                                <input type="number" id="input-family" class="sidebar-input" value="10000">
                            </div>
                            <div>
                                <label for="input-scholarships" class="sidebar-label">Scholarships & Grants ($)</label>
                                <input type="number" id="input-scholarships" class="sidebar-input" value="3000">
                            </div>
                            <div>
                                <label for="input-loans" class="sidebar-label">Loans ($)</label>
                                <input type="number" id="input-loans" class="sidebar-input" value="0">
                            </div>
                        </div>
                    </div>

                    <!-- Hidden Costs -->
                    <div class="bg-white rounded-lg border border-gray-200 p-5 shadow-sm">
                        <h3 class="text-lg font-bold text-gray-900 mb-4">One-Time & Hidden Costs</h3>
                        <div class="space-y-4">
                            <div>
                                <label for="input-visa" class="sidebar-label">Visa & Immigration ($)</label>
                                <input type="number" id="input-visa" class="sidebar-input" value="500">
                            </div>
                            <div>
                                <label for="input-insurance" class="sidebar-label">Health Insurance ($/year)</label>
                                <input type="number" id="input-insurance" class="sidebar-input" value="2000">
                            </div>
                            <div>
                                <label for="input-deposit" class="sidebar-label">Accommodation Deposit ($)</label>
                                <input type="number" id="input-deposit" class="sidebar-input" value="1000">
                            </div>
                        </div>
                    </div>

                    <!-- Your Lifestyle -->
                    <div class="bg-white rounded-lg border border-gray-200 p-5 shadow-sm">
                        <h3 class="text-lg font-bold text-gray-900 mb-4">Your Lifestyle</h3>
                        <div class="space-y-4">
                            <div>
                                <label for="input-lifestyle" class="sidebar-label">Lifestyle Preset</label>
                                <select id="input-lifestyle" class="sidebar-select">
                                    <option value="900">Frugal (~$900/mo)</option>
                                    <option value="1400" selected>Balanced (~$1,400/mo)</option>
                                    <option value="2100">Comfortable (~$2,100/mo)</option>
                                </select>
                            </div>
                            <div>
                                <label for="input-living-monthly" class="sidebar-label">Monthly Living Cost ($)</label>
                                <input type="number" id="input-living-monthly" class="sidebar-input" value="1400">
                            </div>
                        </div>
                    </div>

                    <!-- Your Income -->
                    <div class="bg-white rounded-lg border border-gray-200 p-5 shadow-sm">
                        <h3 class="text-lg font-bold text-gray-900 mb-4">Your Income</h3>
                        <div class="space-y-4">
                            <div>
                                <label for="input-home-salary-result" class="sidebar-label">Home Country Salary ($/mo)</label>
                                <input type="number" id="input-home-salary-result" class="sidebar-input" value="0">
                            </div>
                            <div>
                                <label for="input-oncampus-income" class="sidebar-label">On-Campus Job Income ($/mo)</label>
                                <input type="number" id="input-oncampus-income" class="sidebar-input" value="0">
                            </div>
                        </div>
                    </div>

                    <!-- Hidden input for flights (not editable in sidebar) -->
                    <input type="hidden" id="input-flights" value="0">
                </aside>
            </div>

            <!-- Main Content Area -->
            <div id="main-content-area" class="lg:col-span-3">
                <!-- Single Result View -->
                <main id="single-result-view" class="space-y-8 hidden-view">
                    <h1 id="single-title" class="text-3xl font-bold text-center text-gray-900 mb-4">Your
                        Financial Roadmap: [Program]</h1>

                    <!-- New 2-Column Layout (Inflows vs Outflows) -->
                    <section class="mb-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <!-- Inflows -->
                            <div
                                class="card-hover bg-white rounded-lg border border-green-200 p-5 shadow-sm relative overflow-hidden">
                                <div class="absolute top-0 left-0 w-2 h-full bg-green-500"></div>
                                <h3 class="text-xl font-bold text-gray-900 mb-6">What You Have (Inflows)</h3>
                                <div class="space-y-4">
                                    <div class="flex justify-between items-center">
                                        <span class="text-gray-600">Savings & Family</span>
                                        <span class="font-semibold text-gray-900" id="inflow-savings">$0</span>
                                    </div>
                                    <div class="flex justify-between items-center">
                                        <span class="text-gray-600">Scholarships</span>
                                        <span class="font-semibold text-gray-900" id="inflow-scholarships">$0</span>
                                    </div>
                                    <div class="flex justify-between items-center">
                                        <span class="text-gray-600">Future Income (Est.)</span>
                                        <span class="font-semibold text-gray-900" id="inflow-income">$0</span>
                                    </div>
                                    <div class="border-t border-gray-100 pt-4 flex justify-between items-center">
                                        <span class="font-bold text-gray-900">Total Available</span>
                                        <span class="font-bold text-2xl text-blue-600" id="total-inflows">$0</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Outflows -->
                            <div
                                class="card-hover bg-white rounded-lg border border-red-200 p-5 shadow-sm relative overflow-hidden">
                                <div class="absolute top-0 left-0 w-2 h-full bg-red-500"></div>
                                <h3 class="text-xl font-bold text-gray-900 mb-6">What It Costs (Outflows)</h3>
                                <div class="space-y-4">
                                    <div class="flex justify-between items-center">
                                        <span class="text-gray-600">Tuition</span>
                                        <span class="font-semibold text-gray-900" id="outflow-tuition">$0</span>
                                    </div>
                                    <div class="flex justify-between items-center">
                                        <span class="text-gray-600">Living Expenses</span>
                                        <span class="font-semibold text-gray-900" id="outflow-living">$0</span>
                                    </div>
                                    <div class="flex justify-between items-center">
                                        <span class="text-gray-600">One-time & Annual</span>
                                        <span class="font-semibold text-gray-900" id="outflow-hidden">$0</span>
                                    </div>
                                    <div class="border-t border-gray-100 pt-4 flex justify-between items-center">
                                        <span class="font-bold text-gray-900">Total Cost</span>
                                        <span class="font-bold text-2xl text-gray-800" id="total-outflows">$0</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Funding Gap Hero Card -->
                        <div class="rounded-xl border-2 p-6 shadow-lg text-center relative overflow-hidden transition-all animate-slideInUp"
                            id="gap-card">
                            <div class="relative z-10">
                                <h2 class="text-2xl font-bold text-white mb-3" id="gap-title">Your Funding Gap</h2>
                                <p class="text-white/90 mb-4 text-base" id="gap-text">Calculating...</p>
                                <div class="text-5xl md:text-6xl font-extrabold mb-6 text-white animate-pulse-subtle"
                                    id="funding-gap-display">$0</div>
                                <p class="text-base text-white/80 font-semibold" id="gap-subtext">Funding Gap</p>
                            </div>
                        </div>

                        <!-- Action Recommendations Box (only shows when gap > 0) -->
                        <div id="action-recommendations"
                            class="hidden mt-6 bg-orange-50 border border-orange-200 rounded-lg p-5 shadow-sm">
                            <div class="flex items-start mb-4">
                                <div>
                                    <h3 class="text-xl font-bold text-gray-900 mb-2">How to Close Your Gap</h3>
                                    <p class="text-sm text-gray-600">Here are practical ways to bridge your funding gap:</p>
                                </div>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                                <!-- Scholarships -->
                                <div class="bg-white rounded-lg p-4 border border-orange-100 card-hover">
                                    <h4 class="font-bold text-gray-900 mb-2">Scholarships</h4>
                                    <p class="text-xl font-bold text-orange-600 mb-2" id="scholarship-amount">$10-15K
                                    </p>
                                    <p class="text-sm text-gray-600 mb-3">Merit-based and need-based options available
                                    </p>
                                    <ul class="text-xs text-gray-500 space-y-1">
                                        <li>→ Prodigy Finance</li>
                                        <li>→ School Merit Awards</li>
                                        <li>→ Country-specific grants</li>
                                    </ul>
                                </div>

                                <!-- Part-time Work -->
                                <div class="bg-white rounded-lg p-4 border border-orange-100 card-hover">
                                    <h4 class="font-bold text-gray-900 mb-2">Part-Time Work</h4>
                                    <p class="text-xl font-bold text-orange-600 mb-2" id="work-amount">$800-1,200/mo
                                    </p>
                                    <p class="text-sm text-gray-600 mb-3">On-campus or remote opportunities</p>
                                    <ul class="text-xs text-gray-500 space-y-1">
                                        <li>→ Teaching assistant</li>
                                        <li>→ Research assistant</li>
                                        <li>→ Campus jobs (15-20 hrs/week)</li>
                                    </ul>
                                </div>

                                <!-- Student Loans -->
                                <div class="bg-white rounded-lg p-4 border border-orange-100 card-hover">
                                    <h4 class="font-bold text-gray-900 mb-2">Student Loans</h4>
                                    <p class="text-xl font-bold text-orange-600 mb-2" id="loan-amount">Varies</p>
                                    <p class="text-sm text-gray-600 mb-3">Competitive rates for international students
                                    </p>
                                    <ul class="text-xs text-gray-500 space-y-1">
                                        <li>→ 3.5-6% APR typical</li>
                                        <li>→ No cosigner options</li>
                                        <li>→ Flexible repayment</li>
                                    </ul>
                                </div>
                            </div>

                            <div class="text-center">
                                <button
                                    class="bg-gradient-to-r from-orange-500 to-amber-500 text-white px-6 py-3 rounded-lg font-semibold hover:shadow-md transition-all">
                                    Explore Funding Solutions
                                </button>
                            </div>
                        </div>

                        <!-- Comparison Preview Teaser (hidden when coming from comparison) -->
                        <div id="comparison-preview"
                            class="mt-6 bg-indigo-50 rounded-lg border border-indigo-200 p-5 shadow-sm">
                            <div class="text-center mb-4">
                                <h3 class="text-xl font-bold text-gray-900 mb-2">How does this compare?</h3>
                                <p class="text-sm text-gray-600">Students with similar profiles also considered these programs
                                </p>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4" id="similar-programs-container">
                                <!-- Similar programs will be inserted here by JavaScript -->
                            </div>
                        </div>

                        <!-- Comparison Card (Task C) (hidden when coming from comparison) -->
                        <div id="compare-another-card" class="mt-6 border border-dashed border-gray-300 rounded-lg p-5 text-center cursor-pointer hover:border-indigo-500 hover:bg-indigo-50 transition-all group"
                            onclick="startComparison()">
                            <div class="text-2xl mb-2 text-gray-400 group-hover:text-indigo-500 transition-colors">+
                            </div>
                            <h3 class="text-lg font-bold text-gray-600 group-hover:text-indigo-700 transition-colors">
                                Compare with another program</h3>
                            <p class="text-sm text-gray-500 mt-2">See how this stacks up against another option</p>
                        </div>
                    </section>

                    <!-- Today View - Interactive Timeline Display -->
                    <section
                        class="bg-indigo-50 rounded-lg border border-indigo-100 p-5 shadow-sm">
                        <div class="flex items-center justify-center gap-2 mb-4">
                            <h2 class="text-xl font-bold text-gray-900">Where You Are Today</h2>
                            <span class="bg-green-100 text-green-700 text-xs font-semibold px-2 py-1 rounded-full">Interactive</span>
                        </div>
                        <p class="text-sm text-gray-600 text-center mb-4">Drag the green dot on the chart below to explore different months</p>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="bg-white p-4 rounded-lg shadow-sm border-l-4 border-green-500">
                                <p class="text-sm text-gray-600 mb-2">Your Bank Balance</p>
                                <p id="today-balance" class="text-3xl font-bold text-green-600">$0</p>
                                <p class="text-xs text-gray-500 mt-2">Available funds right now</p>
                            </div>
                            <div class="bg-white p-4 rounded-lg shadow-sm border-l-4 border-orange-500">
                                <p class="text-sm text-gray-600 mb-2">Payment Due This Month</p>
                                <p id="today-next-payment" class="text-3xl font-bold text-orange-600">$0</p>
                                <p class="text-xs text-gray-500 mt-2">Living + Tuition (if applicable)</p>
                            </div>
                        </div>
                    </section>

                    <!-- 24-Month Cash Flow - Interactive Timeline -->
                    <section class="bg-white rounded-lg border border-gray-200 p-5 shadow-sm">
                        <div class="flex items-center justify-between mb-2">
                            <h2 class="text-xl font-bold text-gray-900">Your 24-Month Bank Balance</h2>
                            <div class="flex items-center gap-2 text-xs text-gray-500">
                                <span class="inline-block w-3 h-3 rounded-full bg-green-500"></span>
                                <span>Drag to explore</span>
                            </div>
                        </div>
                        <p class="text-sm text-gray-600 mb-4">Click or drag the green dot to see your balance at any month. The red dashed line is your "Funding Gap".</p>
                        <div class="w-full h-80 cursor-crosshair">
                            <canvas id="cash-flow-chart"></canvas>
                        </div>
                        <div class="mt-4 text-center">
                            <button
                                onclick="document.getElementById('sidebar-controls').scrollIntoView({behavior: 'smooth'})"
                                class="bg-indigo-50 text-indigo-700 px-6 py-2 rounded-lg font-semibold hover:bg-indigo-100 transition-all">
                                Adjust Scenario
                            </button>
                        </div>
                    </section>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                        <!-- Monthly Expense Chart -->
                        <section class="bg-white rounded-lg border border-gray-200 p-5 shadow-sm">
                            <h2 class="text-lg font-bold text-gray-900 mb-2">Monthly Expense Chart</h2>
                            <p class="text-sm text-gray-600 mb-4">Note the spikes for tuition payments in September and
                                January.</p>
                            <div class="w-full h-64">
                                <canvas id="monthly-expense-chart"></canvas>
                            </div>
                        </section>

                        <!-- Expense Breakdown Pie Chart -->
                        <section class="bg-white rounded-lg border border-gray-200 p-5 shadow-sm">
                            <h2 id="single-chart-title" class="text-lg font-bold text-gray-900 mb-2">Living Cost
                                Breakdown</h2>
                            <p class="text-sm text-gray-600 mb-4">A breakdown of your *monthly* living expenses.</p>
                            <div class="w-full h-64">
                                <canvas id="category-pie-chart"></canvas>
                            </div>
                        </section>
                    </div>
                </main>

                <!-- Compare Result View (supports up to 4 programs) -->
                <main id="compare-result-view" class="space-y-6 hidden-view">
                    <div class="flex items-center justify-center gap-3 mb-4">
                        <h1 class="text-3xl font-bold text-center text-gray-900">Your Roadmap Comparison</h1>
                        <span id="compare-count-badge" class="bg-indigo-100 text-indigo-700 text-sm font-semibold px-3 py-1 rounded-full">2 programs</span>
                    </div>
                    
                    <!-- Row 1: Programs A & B (always visible) -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-3" id="compare-cards-row-1">
                        <section id="compare-card-a" class="relative bg-white rounded-lg border border-gray-200 text-center p-4 shadow-sm cursor-pointer hover:shadow-md transition-all"
                            onclick="openSingleFromCompare('A')">
                            <button type="button" class="absolute top-2 right-2 text-xs text-gray-400 hover:text-red-500"
                                onclick="event.stopPropagation(); removeCompareProgram('A');">✕</button>
                            <h2 id="compare-name-a" class="text-lg font-bold text-gray-900 mb-3">[Program A]</h2>
                            <p class="text-sm text-gray-700 mb-1">Total Funding Gap:</p>
                            <p id="compare-gap-a" class="text-3xl font-bold text-red-600 my-3">$22,000</p>
                            <p class="text-xs text-gray-600">Starting Balance: <span id="compare-balance-a"
                                    class="font-semibold">$43,000</span></p>
                        </section>
                        <section id="compare-card-b" class="relative bg-white rounded-lg border border-gray-200 text-center p-4 shadow-sm cursor-pointer hover:shadow-md transition-all"
                            onclick="openSingleFromCompare('B')">
                            <button type="button" class="absolute top-2 right-2 text-xs text-gray-400 hover:text-red-500"
                                onclick="event.stopPropagation(); removeCompareProgram('B');">✕</button>
                            <h2 id="compare-name-b" class="text-lg font-bold text-gray-900 mb-3">[Program B]</h2>
                            <p class="text-sm text-gray-700 mb-1">Total Funding Gap:</p>
                            <p id="compare-gap-b" class="text-3xl font-bold text-green-600 my-3">$14,500</p>
                            <p class="text-xs text-gray-600">Starting Balance: <span id="compare-balance-b"
                                    class="font-semibold">$43,000</span></p>
                        </section>
                    </div>
                    
                    <!-- Row 1 Charts: A & B -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-3" id="compare-charts-row-1">
                        <section class="bg-white rounded-lg border border-gray-200 p-4 shadow-sm">
                            <h2 id="compare-chart-title-a" class="text-base font-bold text-gray-900 mb-3">24-Month Cash
                                Flow: [Program A]</h2>
                            <div class="w-full h-80">
                                <canvas id="compare-chart-a"></canvas>
                            </div>
                        </section>
                        <section class="bg-white rounded-lg border border-gray-200 p-4 shadow-sm">
                            <h2 id="compare-chart-title-b" class="text-base font-bold text-gray-900 mb-3">24-Month Cash
                                Flow: [Program B]</h2>
                            <div class="w-full h-80">
                                <canvas id="compare-chart-b"></canvas>
                            </div>
                        </section>
                    </div>

                    <!-- Row 2: Programs C & D (add program search cards) -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-3" id="compare-cards-row-2">
                        <!-- Card C: Search to add 3rd program -->
                        <section id="compare-card-c" class="relative border-2 border-dashed border-gray-300 rounded-lg p-4 transition-all">
                            <div class="text-center mb-3">
                                <h3 class="text-lg font-semibold text-gray-700">Add 3rd Program</h3>
                                <p class="text-xs text-gray-500">Search by country, university, or program</p>
                            </div>
                            <div class="relative">
                                <div class="flex items-center border border-gray-300 rounded-lg focus-within:border-indigo-500 focus-within:ring-2 focus-within:ring-indigo-100 bg-white">
                                    <div class="pl-3 pr-2">
                                        <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                        </svg>
                                    </div>
                                    <input type="text" id="compare-search-input-c"
                                        class="flex-1 py-2 pr-3 text-sm border-0 focus:outline-none focus:ring-0 bg-transparent"
                                        placeholder="Try 'Spain', 'Harvard', 'MBA'..."
                                        oninput="searchInComparisonCard(this.value, 'C')"
                                        autocomplete="off">
                                </div>
                                <div id="compare-search-results-c"
                                    class="hidden absolute w-full bg-white border border-gray-200 rounded-lg shadow-lg mt-1 max-h-48 overflow-y-auto z-20">
                                </div>
                            </div>
                        </section>
                        <!-- Card D: Initially hidden, search to add 4th program -->
                        <section id="compare-card-d" class="hidden relative border-2 border-dashed border-gray-300 rounded-lg p-4 transition-all">
                            <div class="text-center mb-3">
                                <h3 class="text-lg font-semibold text-gray-700">Add 4th Program</h3>
                                <p class="text-xs text-gray-500">Search by country, university, or program</p>
                            </div>
                            <div class="relative">
                                <div class="flex items-center border border-gray-300 rounded-lg focus-within:border-indigo-500 focus-within:ring-2 focus-within:ring-indigo-100 bg-white">
                                    <div class="pl-3 pr-2">
                                        <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                        </svg>
                                    </div>
                                    <input type="text" id="compare-search-input-d"
                                        class="flex-1 py-2 pr-3 text-sm border-0 focus:outline-none focus:ring-0 bg-transparent"
                                        placeholder="Try 'UK', 'INSEAD', 'Finance'..."
                                        oninput="searchInComparisonCard(this.value, 'D')"
                                        autocomplete="off">
                                </div>
                                <div id="compare-search-results-d"
                                    class="hidden absolute w-full bg-white border border-gray-200 rounded-lg shadow-lg mt-1 max-h-48 overflow-y-auto z-20">
                                </div>
                            </div>
                        </section>
                    </div>
                    
                    <!-- Row 2 Charts: C & D (hidden by default) -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-3 hidden" id="compare-charts-row-2">
                        <section id="compare-chart-section-c" class="bg-white rounded-lg border border-gray-200 p-4 shadow-sm hidden">
                            <h2 id="compare-chart-title-c" class="text-base font-bold text-gray-900 mb-3">24-Month Cash
                                Flow: [Program C]</h2>
                            <div class="w-full h-80">
                                <canvas id="compare-chart-c"></canvas>
                            </div>
                        </section>
                        <section id="compare-chart-section-d" class="bg-white rounded-lg border border-gray-200 p-4 shadow-sm hidden">
                            <h2 id="compare-chart-title-d" class="text-base font-bold text-gray-900 mb-3">24-Month Cash
                                Flow: [Program D]</h2>
                            <div class="w-full h-80">
                                <canvas id="compare-chart-d"></canvas>
                            </div>
                        </section>
                    </div>
                </main>

                <!-- Final Actions -->
                <footer id="final-actions" class="flex flex-col md:flex-row justify-center items-center gap-4 pt-6">
                    <a href="simulator.html"
                        class="bg-white border border-gray-200 text-gray-700 px-6 py-3 rounded-lg font-semibold hover:border-gray-300 hover:shadow-md transition-all">
                        ← Start Over
                    </a>
                    <button id="save-button" onclick="savePlanToDashboard()"
                        class="gradient-bg text-white px-6 py-3 rounded-lg font-semibold hover:shadow-md transition-all">
                        Save Plan
                    </button>
                </footer>
            </div>
        </div>
    </div>

    <script>
        // Global store for chart instances
        let chartInstances = {};

        const destroyChart = (chartId) => {
            if (chartInstances[chartId]) {
                chartInstances[chartId].destroy();
                delete chartInstances[chartId];
            }
        };

        const formatCurrency = (num) => {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0,
            }).format(num);
        };

        const getGapColor = (num) => {
            return num > 0 ? '#dc2626' : '#16a34a';
        };

        // Global state for draggable timeline
        let currentSelectedMonth = 0;
        let chartBalanceData = [];
        let chartPaymentInfo = [];
        let chartLabels = [];

        const updateTodaySection = (monthIndex) => {
            if (!chartBalanceData.length || !chartPaymentInfo.length) return;
            
            const balance = chartBalanceData[monthIndex] || 0;
            const info = chartPaymentInfo[monthIndex] || { living: 0, tuitionAmount: 0 };
            const nextPayment = info.living + info.tuitionAmount;
            
            document.getElementById('today-balance').textContent = formatCurrency(balance);
            document.getElementById('today-next-payment').textContent = formatCurrency(nextPayment);
            
            // Update label to show selected month
            const labelEl = document.querySelector('#today-balance + p');
            if (labelEl && chartLabels[monthIndex]) {
                const monthLabel = Array.isArray(chartLabels[monthIndex]) ? chartLabels[monthIndex][0] : chartLabels[monthIndex];
                labelEl.textContent = monthIndex === currentSelectedMonth ? 'Available funds right now' : `Balance at ${monthLabel}`;
            }
        };

        const moveTodayDot = (chart, newIndex) => {
            if (newIndex < 0 || newIndex >= chartBalanceData.length) return;
            
            currentSelectedMonth = newIndex;
            
            // Find the "Today" dataset by label (it's the one with order: 1)
            const todayDatasetIndex = chart.data.datasets.findIndex(ds => ds.label === 'Today');
            if (todayDatasetIndex === -1) return;
            
            // Update the "Today" dataset to show the dot at the new position
            chart.data.datasets[todayDatasetIndex].data = chartBalanceData.map((val, i) => i === newIndex ? val : null);
            
            // Update labels to reflect current position
            chart.data.labels = chartLabels.map((label, i) => {
                if (i === newIndex) {
                    return ['Selected', Array.isArray(label) ? label[1] : `Sem ${Math.floor(i / 6) + 1}`];
                }
                return label;
            });
            
            chart.update('none'); // Update without animation for smooth dragging
            updateTodaySection(newIndex);
        };

        const createCashFlowChart = (ctxId, duration, personalFunds, monthlyLiving, tuition, monthlyIncome = 0) => {
            destroyChart(ctxId);
            const ctx = document.getElementById(ctxId).getContext('2d');

            let tuitionPayment;
            let tuitionMonths;

            if (duration === 12) {
                tuitionPayment = tuition / 2;
                tuitionMonths = [0, 5];
            } else {
                tuitionPayment = tuition / 4;
                tuitionMonths = [0, 5, 12, 17];
            }

            const adjustedDuration = duration <= 12 ? 11 : 23;

            const labels = [];
            const balanceData = [];
            const todayPointData = [];
            const paymentInfo = []; // Track payment info for tooltips
            let currentBalance = personalFunds;
            const startDate = new Date(2025, 6, 1);

            const today = new Date();
            const initialMonthIndex = Math.max(0, Math.min(adjustedDuration - 1, Math.floor((today.getTime() - startDate.getTime()) / (1000 * 60 * 60 * 24 * 30))));
            currentSelectedMonth = initialMonthIndex;

            for (let i = 0; i < adjustedDuration; i++) {
                const currentDate = new Date(startDate.getFullYear(), startDate.getMonth() + i, 1);
                const month = (currentDate.getMonth() + 1).toString().padStart(2, '0');
                const year = currentDate.getFullYear().toString().slice(-2);

                const semester = Math.floor(i / 6) + 1;
                const semesterLabel = `Sem ${semester}`;

                if (i === initialMonthIndex) {
                    labels.push(['Selected', semesterLabel]);
                } else {
                    labels.push([`${month}/${year}`, semesterLabel]);
                }

                let monthlyExpense = monthlyLiving;
                const adjustedTuitionMonths = tuitionMonths.map(m => m + 1);
                const hasTuitionPayment = adjustedTuitionMonths.includes(i);

                if (hasTuitionPayment) {
                    monthlyExpense += tuitionPayment;
                }

                currentBalance -= monthlyExpense;
                currentBalance += monthlyIncome;

                // Store payment info for tooltip
                paymentInfo.push({
                    hasTuition: hasTuitionPayment,
                    tuitionAmount: hasTuitionPayment ? tuitionPayment : 0,
                    living: monthlyLiving,
                    income: monthlyIncome
                });

                balanceData.push(currentBalance);
                todayPointData.push(i === initialMonthIndex ? currentBalance : null);
            }

            // Store globally for dragging
            chartBalanceData = balanceData;
            chartPaymentInfo = paymentInfo;
            chartLabels = labels.map(l => l); // Clone

            // Update the "Where You Are Today" section immediately
            updateTodaySection(initialMonthIndex);

            chartInstances[ctxId] = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Funding Gap (Zero Line)',
                            data: Array(adjustedDuration).fill(0),
                            borderColor: '#dc2626',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            fill: false,
                            pointRadius: 0,
                            order: 3 // Render first (behind)
                        },
                        {
                            label: 'Your Bank Balance',
                            data: balanceData,
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            fill: true,
                            tension: 0.1,
                            pointRadius: 0,
                            order: 2 // Render second
                        },
                        {
                            label: 'Today',
                            data: todayPointData,
                            borderColor: '#10b981',
                            backgroundColor: '#10b981',
                            pointRadius: 9,
                            pointHoverRadius: 11,
                            pointStyle: 'circle',
                            borderWidth: 2,
                            order: 1, // Render last (on top)
                            hitRadius: 30 // Larger hit area for easier clicking
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    scales: {
                        y: {
                            ticks: { callback: (value) => formatCurrency(value) }
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            filter: (tooltipItem) => tooltipItem.datasetIndex === 1, // Only show tooltip for balance line
                            callbacks: {
                                label: (context) => {
                                    const index = context.dataIndex;
                                    const balance = chartBalanceData[index];
                                    const info = chartPaymentInfo[index];

                                    const lines = [`Balance: ${formatCurrency(balance)}`];

                                    if (info && info.hasTuition) {
                                        lines.push(`Tuition payment: ${formatCurrency(info.tuitionAmount)}`);
                                    }
                                    if (info && info.income > 0) {
                                        lines.push(`Income: +${formatCurrency(info.income)}`);
                                    }
                                    if (info) {
                                        lines.push(`Living: -${formatCurrency(info.living)}`);
                                    }
                                    lines.push('');
                                    lines.push('Click to move timeline here');

                                    return lines;
                                },
                                title: (context) => {
                                    const index = context[0].dataIndex;
                                    return index === currentSelectedMonth ? 'CURRENT SELECTION' : context[0].label;
                                }
                            }
                        }
                    },
                    onClick: (event, elements, chart) => {
                        // Get the x-axis position of the click
                        const canvasPosition = Chart.helpers.getRelativePosition(event, chart);
                        const xScale = chart.scales.x;
                        const clickedIndex = xScale.getValueForPixel(canvasPosition.x);
                        const roundedIndex = Math.round(clickedIndex);
                        
                        if (roundedIndex >= 0 && roundedIndex < chartBalanceData.length) {
                            moveTodayDot(chart, roundedIndex);
                        }
                    },
                    onHover: (event, elements, chart) => {
                        const canvas = chart.canvas;
                        canvas.style.cursor = elements.length > 0 ? 'pointer' : 'crosshair';
                    }
                }
            });

            // Add drag support
            const canvas = document.getElementById(ctxId);
            let isDragging = false;

            canvas.addEventListener('mousedown', (e) => {
                isDragging = true;
                canvas.style.cursor = 'grabbing';
            });

            canvas.addEventListener('mousemove', (e) => {
                if (!isDragging) return;
                
                const chart = chartInstances[ctxId];
                if (!chart) return;
                
                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const xScale = chart.scales.x;
                const clickedIndex = xScale.getValueForPixel(x);
                const roundedIndex = Math.round(clickedIndex);
                
                if (roundedIndex >= 0 && roundedIndex < chartBalanceData.length && roundedIndex !== currentSelectedMonth) {
                    moveTodayDot(chart, roundedIndex);
                }
            });

            canvas.addEventListener('mouseup', () => {
                isDragging = false;
                canvas.style.cursor = 'crosshair';
            });

            canvas.addEventListener('mouseleave', () => {
                isDragging = false;
            });

            // Touch support for mobile
            canvas.addEventListener('touchstart', (e) => {
                isDragging = true;
                e.preventDefault();
            }, { passive: false });

            canvas.addEventListener('touchmove', (e) => {
                if (!isDragging) return;
                e.preventDefault();
                
                const chart = chartInstances[ctxId];
                if (!chart) return;
                
                const touch = e.touches[0];
                const rect = canvas.getBoundingClientRect();
                const x = touch.clientX - rect.left;
                const xScale = chart.scales.x;
                const clickedIndex = xScale.getValueForPixel(x);
                const roundedIndex = Math.round(clickedIndex);
                
                if (roundedIndex >= 0 && roundedIndex < chartBalanceData.length && roundedIndex !== currentSelectedMonth) {
                    moveTodayDot(chart, roundedIndex);
                }
            }, { passive: false });

            canvas.addEventListener('touchend', () => {
                isDragging = false;
            });
        };

        const createMonthlyExpenseChart = (ctxId, duration, monthlyLiving, tuition) => {
            destroyChart(ctxId);
            const ctx = document.getElementById(ctxId).getContext('2d');

            let tuitionPayment;
            let tuitionMonths;

            if (duration === 12) {
                tuitionPayment = tuition / 2;
                tuitionMonths = [0, 5];
            } else {
                tuitionPayment = tuition / 4;
                tuitionMonths = [0, 5, 12, 17];
            }

            const adjustedDuration = duration <= 12 ? 11 : 23;

            const labels = [];
            const expenseData = [];
            const startDate = new Date(2025, 6, 1);
            const adjustedTuitionMonths = tuitionMonths.map(m => m + 1);

            for (let i = 0; i < adjustedDuration; i++) {
                const currentDate = new Date(startDate.getFullYear(), startDate.getMonth() + i, 1);
                const month = (currentDate.getMonth() + 1).toString().padStart(2, '0');
                const year = currentDate.getFullYear().toString().slice(-2);
                labels.push(`${month}/${year}`);

                let monthlyExpense = monthlyLiving;
                if (adjustedTuitionMonths.includes(i)) {
                    monthlyExpense += tuitionPayment;
                }
                expenseData.push(monthlyExpense);
            }

            chartInstances[ctxId] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Monthly Expense',
                        data: expenseData,
                        backgroundColor: expenseData.map(d => d > monthlyLiving ? '#f59e0b' : '#667eea'),
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { ticks: { callback: (value) => formatCurrency(value) } } },
                    plugins: {
                        legend: { display: false },
                        tooltip: { callbacks: { label: (context) => `Expense: ${formatCurrency(context.raw)}` } }
                    }
                }
            });
        };

        const createCategoryPieChart = (ctxId, monthlyLiving) => {
            destroyChart(ctxId);
            const ctx = document.getElementById(ctxId).getContext('2d');

            const housing = monthlyLiving * 0.5;
            const lifestyle = monthlyLiving * 0.3;
            const other = monthlyLiving * 0.2;
            const total = housing + lifestyle + other;

            chartInstances[ctxId] = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Housing (50%)', 'Lifestyle (30%)', 'Other (20%)'],
                    datasets: [{
                        data: [housing, lifestyle, other],
                        backgroundColor: ['#667eea', '#fbbf24', '#10b981'],
                        borderColor: '#ffffff',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { 
                            position: 'bottom', 
                            labels: { 
                                font: { family: "'Inter', sans-serif", size: 14 },
                                generateLabels: (chart) => {
                                    const data = chart.data;
                                    if (data.labels.length && data.datasets.length) {
                                        return data.labels.map((label, i) => {
                                            const value = data.datasets[0].data[i];
                                            const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
                                            return {
                                                text: `${label.split(' (')[0]} - ${formatCurrency(value)} (${percentage}%)`,
                                                fillStyle: data.datasets[0].backgroundColor[i],
                                                strokeStyle: data.datasets[0].borderColor,
                                                lineWidth: data.datasets[0].borderWidth,
                                                hidden: false,
                                                index: i
                                            };
                                        });
                                    }
                                    return [];
                                }
                            } 
                        },
                        tooltip: { 
                            callbacks: { 
                                label: (context) => {
                                    const value = context.raw;
                                    const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
                                    return `${context.label.split(' (')[0]}: ${formatCurrency(value)}/mo (${percentage}%)`;
                                }
                            } 
                        }
                    }
                }
            });
        };

        const updateDashboard = () => {
            // Your Funds
            const savings = parseFloat(document.getElementById('input-savings').value) || 0;
            const family = parseFloat(document.getElementById('input-family').value) || 0;
            const scholarships = parseFloat(document.getElementById('input-scholarships').value) || 0;
            const loans = parseFloat(document.getElementById('input-loans').value) || 0;
            
            // Program Costs (read-only)
            const tuition = parseFloat(document.getElementById('input-tuition').value) || 0;
            const duration = parseFloat(document.getElementById('input-duration').value) || 1;
            
            // Lifestyle
            const monthlyLiving = parseFloat(document.getElementById('input-living-monthly').value) || 0;
            
            // Income
            const homeSalaryMonthly = parseFloat(document.getElementById('input-home-salary-result').value) || 0;
            const oncampusIncome = parseFloat(document.getElementById('input-oncampus-income').value) || 0;
            const monthlyIncome = homeSalaryMonthly + oncampusIncome;

            // Hidden costs (now visible in sidebar)
            const flights = parseFloat(document.getElementById('input-flights').value) || 0;
            const visa = parseFloat(document.getElementById('input-visa').value) || 0;
            const insurance = parseFloat(document.getElementById('input-insurance').value) || 0;
            const deposit = parseFloat(document.getElementById('input-deposit').value) || 0;
            const oneTimeExpenses = flights + visa + deposit;
            const recurringAnnual = insurance * (duration / 12);
            const totalHiddenCosts = oneTimeExpenses + recurringAnnual;

            const personalFunds = savings + family + scholarships + loans;
            const totalLivingCost = monthlyLiving * duration;
            const totalCost = tuition + totalLivingCost + totalHiddenCosts;
            const totalIncome = monthlyIncome * duration;
            const totalAvailable = personalFunds + totalIncome;
            const fundingGap = totalCost - totalAvailable;

            // Update Inflows
            document.getElementById('inflow-savings').textContent = formatCurrency(savings + family);
            document.getElementById('inflow-scholarships').textContent = formatCurrency(scholarships);
            document.getElementById('inflow-income').textContent = formatCurrency(totalIncome);
            document.getElementById('total-inflows').textContent = formatCurrency(totalAvailable);

            // Update Outflows
            document.getElementById('outflow-tuition').textContent = formatCurrency(tuition);
            document.getElementById('outflow-living').textContent = formatCurrency(totalLivingCost);
            document.getElementById('outflow-hidden').textContent = formatCurrency(totalHiddenCosts);
            document.getElementById('total-outflows').textContent = formatCurrency(totalCost);

            // Update Funding Gap Highlight
            const gapDisplay = document.getElementById('funding-gap-display');
            const gapCard = document.getElementById('gap-card');
            const gapText = document.getElementById('gap-text');
            const gapSubtext = document.getElementById('gap-subtext');
            const gapTitle = document.getElementById('gap-title');

            gapDisplay.textContent = formatCurrency(Math.abs(fundingGap));

            if (fundingGap > 0) {
                // Deficit - Red gradient
                gapCard.classList.remove('gradient-surplus');
                gapCard.classList.add('gradient-deficit');
                gapText.textContent = `You need ${formatCurrency(fundingGap)} more to complete your plan.`;
                gapSubtext.textContent = "Funding Gap";
                gapTitle.textContent = "Your Funding Gap";
            } else {
                // Surplus - Green gradient
                gapCard.classList.remove('gradient-deficit');
                gapCard.classList.add('gradient-surplus');
                gapText.textContent = "Congratulations! You're fully funded with a surplus.";
                gapSubtext.textContent = "Surplus";
                gapTitle.textContent = "You're Fully Funded!";
            }

            // Show/hide action recommendations based on funding gap
            const recommendationsBox = document.getElementById('action-recommendations');
            if (fundingGap > 0) {
                recommendationsBox.classList.remove('hidden');
                // Update scholarship amount (suggest 20-30% of gap)
                const scholarshipSuggestion = Math.round(fundingGap * 0.25 / 1000) * 1000;
                document.getElementById('scholarship-amount').textContent = `$${(scholarshipSuggestion / 1000).toFixed(0)}-${((scholarshipSuggestion * 1.5) / 1000).toFixed(0)}K`;

                // Update work amount based on duration
                const monthlyWork = 1000; // Average
                const totalWorkIncome = monthlyWork * duration;
                document.getElementById('work-amount').textContent = `$${monthlyWork.toLocaleString()}/mo`;

                // Update loan amount (remaining gap after scholarships and work)
                const remainingGap = Math.max(0, fundingGap - scholarshipSuggestion - totalWorkIncome);
                if (remainingGap > 0) {
                    document.getElementById('loan-amount').textContent = formatCurrency(remainingGap);
                } else {
                    document.getElementById('loan-amount').textContent = 'Optional';
                }
            } else {
                recommendationsBox.classList.add('hidden');
            }

            // Update Charts
            const today = new Date();
            const startDate = new Date(2025, 6, 1);
            const currentMonthIndex = Math.max(0, Math.floor((today.getTime() - startDate.getTime()) / (1000 * 60 * 60 * 24 * 30)));

            let currentBalance = personalFunds;
            // Note: This simple loop doesn't account for hidden costs timing perfectly, but good enough for now
            // We'll assume hidden costs are paid upfront or spread. Let's assume upfront for simplicity in "Today" view logic if needed.
            // But for the chart, we might want to distribute them.
            // For now, let's keep the chart logic simple as per existing code, maybe adding hidden costs to initial outflow?

            // Existing chart logic...
            createCashFlowChart('cash-flow-chart', duration, personalFunds, monthlyLiving, tuition, monthlyIncome);
            createMonthlyExpenseChart('monthly-expense-chart', duration, monthlyLiving, tuition);
            createCategoryPieChart('category-pie-chart', monthlyLiving);
        };

        // Layout helpers for sidebar/main content
        function showSidebar() {
            const sidebarColumn = document.getElementById('sidebar-column');
            const sidebarControls = document.getElementById('sidebar-controls');
            const mainContentArea = document.getElementById('main-content-area');
            if (sidebarColumn) sidebarColumn.classList.remove('hidden', 'lg:hidden');
            if (sidebarControls) sidebarControls.classList.remove('hidden-view');
            if (mainContentArea) {
                mainContentArea.classList.remove('lg:col-span-4');
                mainContentArea.classList.add('lg:col-span-3');
            }
        }

        function hideSidebar() {
            const sidebarColumn = document.getElementById('sidebar-column');
            const sidebarControls = document.getElementById('sidebar-controls');
            const mainContentArea = document.getElementById('main-content-area');
            if (sidebarColumn) sidebarColumn.classList.add('hidden', 'lg:hidden');
            if (sidebarControls) sidebarControls.classList.add('hidden-view');
            if (mainContentArea) {
                mainContentArea.classList.remove('lg:col-span-3');
                mainContentArea.classList.add('lg:col-span-4');
            }
        }

        const startComparison = () => {
            const params = new URLSearchParams(window.location.search);
            // Save current params to sessionStorage to retrieve later
            sessionStorage.setItem('compare_program_a', params.toString());
            window.location.href = 'simulator.html?mode=compare';
        };

        // Store current program data for comparison
        let currentProgramData = null;

        const addToComparison = (programB) => {
            if (!currentProgramData) return;
            
            // Get current sidebar values for funds
            const savings = parseFloat(document.getElementById('input-savings').value) || 0;
            const family = parseFloat(document.getElementById('input-family').value) || 0;
            const scholarships = parseFloat(document.getElementById('input-scholarships').value) || 0;
            const loans = parseFloat(document.getElementById('input-loans').value) || 0;
            const monthlyLiving = parseFloat(document.getElementById('input-living-monthly').value) || 1400;
            
            // Calculate costs for program B
            const livingCostB = monthlyLiving * programB.duration;
            const totalCostB = programB.tuition + livingCostB;
            const personalFunds = savings + family + scholarships + loans;
            const gapB = totalCostB - personalFunds;
            
            // Build comparison URL with both programs
            const params = new URLSearchParams({
                simType: 'compare',
                // Program A (current)
                nameA: currentProgramData.name,
                tuitionA: currentProgramData.tuition,
                livingA: currentProgramData.living,
                costA: currentProgramData.cost,
                gapA: currentProgramData.gap,
                duration: currentProgramData.duration,
                // Program B (selected similar program)
                nameB: `${programB.name} - ${programB.program}`,
                tuitionB: programB.tuition,
                livingB: livingCostB,
                costB: totalCostB,
                gapB: gapB,
                durationB: programB.duration,
                // Shared funds
                savings: savings,
                family: family,
                scholarships: scholarships
            });
            
            window.location.href = `results.html?${params.toString()}`;
        };

        const generateSimilarPrograms = (currentProgram, currentTuition) => {
            // Generate 3 similar programs with varied tuition (±20%)
            const similarPrograms = [
                {
                    name: 'ESADE Business School',
                    program: 'Master in Management',
                    country: 'Spain',
                    tuition: Math.round(currentTuition * 0.85),
                    duration: 24,
                    tag: 'More Affordable'
                },
                {
                    name: 'London School of Economics',
                    program: 'MSc Management',
                    country: 'United Kingdom',
                    tuition: Math.round(currentTuition * 1.15),
                    duration: 12,
                    tag: 'Shorter Duration'
                },
                {
                    name: 'HEC Paris',
                    program: 'Master in Management',
                    country: 'France',
                    tuition: Math.round(currentTuition * 0.95),
                    duration: 24,
                    tag: 'Similar Cost'
                }
            ];

            // Store for global access
            window.similarProgramsList = similarPrograms;

            const container = document.getElementById('similar-programs-container');
            if (!container) return;

            container.innerHTML = similarPrograms.map((prog, index) => `
                <div class="card-hover bg-white rounded-lg border border-indigo-100 p-4 shadow-sm">
                    <div class="flex justify-between items-start mb-3">
                        <span class="text-xs font-semibold px-3 py-1 bg-indigo-100 text-indigo-700 rounded-full">${prog.tag}</span>
                    </div>
                    <h4 class="font-bold text-gray-900 mb-1">${prog.name}</h4>
                    <p class="text-sm text-gray-600 mb-3">${prog.program} • ${prog.country}</p>
                    <div class="border-t border-gray-100 pt-3 mt-3">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-xs text-gray-500">Tuition</span>
                            <span class="font-bold text-indigo-600">${formatCurrency(prog.tuition)}</span>
                        </div>
                        <div class="flex justify-between items-center mb-3">
                            <span class="text-xs text-gray-500">Duration</span>
                            <span class="text-sm font-semibold text-gray-700">${prog.duration} months</span>
                        </div>
                        <button onclick="addToComparison(window.similarProgramsList[${index}])" class="w-full bg-indigo-50 text-indigo-700 px-4 py-2 rounded-lg font-semibold text-sm hover:bg-indigo-100 transition-all">
                            Add to Comparison
                        </button>
                    </div>
                </div>
            `).join('');
        };

        document.addEventListener('DOMContentLoaded', () => {
            const params = new URLSearchParams(window.location.search);
            const simType = params.get('simType') || 'single';

            const nameA = params.get('nameA') || 'Master in Management';
            const gapA = parseFloat(params.get('gapA')) || 22000;
            const costA = parseFloat(params.get('costA')) || 65000;
            const tuitionA = parseFloat(params.get('tuitionA')) || 45000;
            const livingA = parseFloat(params.get('livingA')) || 20000;
            const durationA = parseFloat(params.get('duration')) || 24;
            const personalFundsA = costA - gapA;
            const monthlyLivingA = livingA / durationA;
            const savingsA = parseFloat(params.get('savings')) || 18000;
            const familyA = parseFloat(params.get('family')) || 20000;
            const scholarshipsA = parseFloat(params.get('scholarships')) || 5000;

            if (simType === 'single') {
                showSidebar();
                document.getElementById('single-result-view').classList.remove('hidden-view');

                const savingsFromUrl = parseFloat(params.get('savings')) || savingsA;
                const familyFromUrl = parseFloat(params.get('family')) || familyA;
                const scholarshipsFromUrl = parseFloat(params.get('scholarships')) || scholarshipsA;
                const monthlyLivingFromUrl = parseFloat(params.get('monthlyLiving')) || monthlyLivingA;

                document.getElementById('single-title').textContent = `Your Financial Roadmap: ${nameA}`;
                document.getElementById('save-button').textContent = 'Save Plan to Dashboard';
                document.getElementById('input-savings').value = savingsFromUrl;
                document.getElementById('input-family').value = familyFromUrl;
                document.getElementById('input-scholarships').value = scholarshipsFromUrl;
                document.getElementById('input-tuition').value = tuitionA;
                document.getElementById('input-duration').value = durationA;

                const lifestyleFromUrl = params.get('lifestyle') || 'balanced';
                const lifestyleValue = lifestyleFromUrl === 'frugal' ? 900 : lifestyleFromUrl === 'comfortable' ? 2100 : 1400;
                document.getElementById('input-lifestyle').value = lifestyleValue.toString();
                document.getElementById('input-living-monthly').value = Math.round(monthlyLivingFromUrl || lifestyleValue);

                const homeSalaryFromUrl = parseFloat(params.get('homeSalaryMonthly')) || 0;
                const oncampusIncomeFromUrl = parseFloat(params.get('monthlyOnCampusIncome')) || 0;
                document.getElementById('input-home-salary-result').value = homeSalaryFromUrl;
                document.getElementById('input-oncampus-income').value = Math.round(oncampusIncomeFromUrl);

                // Populate hidden costs
                document.getElementById('input-flights').value = parseFloat(params.get('flights')) || 0;
                document.getElementById('input-visa').value = parseFloat(params.get('visa')) || 0;
                document.getElementById('input-insurance').value = parseFloat(params.get('insurance')) || 0;
                document.getElementById('input-deposit').value = parseFloat(params.get('deposit')) || 0;

                const inputs = document.querySelectorAll('#sidebar-controls input, #sidebar-controls select');
                inputs.forEach(input => {
                    input.addEventListener('change', updateDashboard);
                });

                document.getElementById('input-lifestyle').addEventListener('change', (e) => {
                    const selectedValue = e.target.options[e.target.selectedIndex].value;
                    document.getElementById('input-living-monthly').value = selectedValue;
                    updateDashboard();
                });
                document.getElementById('input-living-monthly').addEventListener('change', () => {
                    updateDashboard();
                });

                updateDashboard();

                // Store current program data for comparison feature
                currentProgramData = {
                    name: nameA,
                    tuition: tuitionA,
                    living: livingA,
                    cost: costA,
                    gap: gapA,
                    duration: durationA,
                    personalFunds: personalFundsA,
                    savings: savingsA,
                    family: familyA,
                    scholarships: scholarshipsA
                };

                // Generate similar programs for comparison preview
                generateSimilarPrograms(nameA, tuitionA);

            } else {
                // Comparison mode: keep sidebar visible but reduce card widths
                showSidebar();
                document.getElementById('compare-result-view').classList.remove('hidden-view');

                const nameB = params.get('nameB') || 'MSc in Finance';
                const gapB = parseFloat(params.get('gapB')) || 14500;
                const costB = parseFloat(params.get('costB')) || 52500;
                const tuitionB = parseFloat(params.get('tuitionB')) || 38000;
                const livingB = parseFloat(params.get('livingB')) || 14500;
                const durationB = parseFloat(params.get('duration')) || 24;
                const personalFundsB = costB - gapB;
                const monthlyLivingB = livingB / durationB;

                // Store current compare payloads for interactions
                // Initialize comparison with up to 4 programs (A, B always; C, D optional)
                window.comparePrograms = {
                    A: {
                        name: nameA,
                        tuition: tuitionA,
                        living: livingA,
                        cost: costA,
                        gap: gapA,
                        duration: durationA,
                        personalFunds: personalFundsA,
                        monthlyLiving: monthlyLivingA,
                        savings: savingsA,
                        family: familyA,
                        scholarships: scholarshipsA,
                        lifestyle: params.get('lifestyle') || 'balanced',
                        monthlyLivingInput: monthlyLivingA,
                    },
                    B: {
                        name: nameB,
                        tuition: tuitionB,
                        living: livingB,
                        cost: costB,
                        gap: gapB,
                        duration: durationB,
                        personalFunds: personalFundsB,
                        monthlyLiving: monthlyLivingB,
                        savings: savingsA,
                        family: familyA,
                        scholarships: scholarshipsA,
                        lifestyle: params.get('lifestyle') || 'balanced',
                        monthlyLivingInput: monthlyLivingB,
                    },
                    C: null, // Slot for 3rd program
                    D: null  // Slot for 4th program
                };
                
                // Check if C and D are provided in URL params
                const nameC = params.get('nameC');
                const nameD = params.get('nameD');
                
                if (nameC) {
                    const tuitionC = parseFloat(params.get('tuitionC')) || 0;
                    const livingC = parseFloat(params.get('livingC')) || 0;
                    const costC = parseFloat(params.get('costC')) || 0;
                    const gapC = parseFloat(params.get('gapC')) || 0;
                    const durationC = parseFloat(params.get('durationC')) || 24;
                    
                    window.comparePrograms.C = {
                        name: nameC,
                        tuition: tuitionC,
                        living: livingC,
                        cost: costC,
                        gap: gapC,
                        duration: durationC,
                        personalFunds: costC - gapC,
                        monthlyLiving: livingC / durationC,
                        savings: savingsA,
                        family: familyA,
                        scholarships: scholarshipsA,
                        lifestyle: params.get('lifestyle') || 'balanced',
                        monthlyLivingInput: livingC / durationC,
                    };
                }
                
                if (nameD) {
                    const tuitionD = parseFloat(params.get('tuitionD')) || 0;
                    const livingD = parseFloat(params.get('livingD')) || 0;
                    const costD = parseFloat(params.get('costD')) || 0;
                    const gapD = parseFloat(params.get('gapD')) || 0;
                    const durationD = parseFloat(params.get('durationD')) || 24;
                    
                    window.comparePrograms.D = {
                        name: nameD,
                        tuition: tuitionD,
                        living: livingD,
                        cost: costD,
                        gap: gapD,
                        duration: durationD,
                        personalFunds: costD - gapD,
                        monthlyLiving: livingD / durationD,
                        savings: savingsA,
                        family: familyA,
                        scholarships: scholarshipsA,
                        lifestyle: params.get('lifestyle') || 'balanced',
                        monthlyLivingInput: livingD / durationD,
                    };
                }

                document.getElementById('compare-name-a').textContent = nameA;
                document.getElementById('compare-gap-a').textContent = formatCurrency(gapA);
                document.getElementById('compare-gap-a').style.color = getGapColor(gapA);
                document.getElementById('compare-balance-a').textContent = formatCurrency(personalFundsA);
                document.getElementById('compare-chart-title-a').textContent = `24-Month Cash Flow: ${nameA}`;

                document.getElementById('compare-name-b').textContent = nameB;
                document.getElementById('compare-gap-b').textContent = formatCurrency(gapB);
                document.getElementById('compare-gap-b').style.color = getGapColor(gapB);
                document.getElementById('compare-balance-b').textContent = formatCurrency(personalFundsB);
                document.getElementById('compare-chart-title-b').textContent = `24-Month Cash Flow: ${nameB}`;

                document.getElementById('save-button').textContent = 'Save Comparison';

                const recalcComparisonFromSidebar = () => {
                    if (!window.comparePrograms) return;

                    const savings = parseFloat(document.getElementById('input-savings').value) || 0;
                    const family = parseFloat(document.getElementById('input-family').value) || 0;
                    const scholarships = parseFloat(document.getElementById('input-scholarships').value) || 0;
                    const loans = parseFloat(document.getElementById('input-loans').value) || 0;
                    const homeSalaryMonthly = parseFloat(document.getElementById('input-home-salary-result').value) || 0;
                    const oncampusIncome = parseFloat(document.getElementById('input-oncampus-income').value) || 0;
                    const monthlyIncome = homeSalaryMonthly + oncampusIncome;

                    const flights = parseFloat(document.getElementById('input-flights').value) || 0;
                    const visa = parseFloat(document.getElementById('input-visa').value) || 0;
                    const insurance = parseFloat(document.getElementById('input-insurance').value) || 0;
                    const deposit = parseFloat(document.getElementById('input-deposit').value) || 0;
                    const oneTimeExpenses = flights + visa + deposit;

                    const totalPersonalFunds = savings + family + scholarships + loans;

                    // Support up to 4 programs (A, B, C, D)
                    ['A', 'B', 'C', 'D'].forEach(side => {
                        const prog = window.comparePrograms[side];
                        if (!prog) return;
                        
                        const dur = prog.duration || 24;
                        const tuition = prog.tuition || 0;
                        const livingTotal = prog.living || 0;
                        const monthlyLiving = livingTotal / dur;
                        const recurringAnnual = insurance * (dur / 12);
                        const totalCost = tuition + livingTotal + oneTimeExpenses + recurringAnnual;
                        const gap = totalCost - totalPersonalFunds;
                        const personalFunds = totalPersonalFunds;

                        prog.gap = gap;
                        prog.cost = totalCost;
                        prog.personalFunds = personalFunds;

                        const gapEl = document.getElementById(`compare-gap-${side.toLowerCase()}`);
                        const balEl = document.getElementById(`compare-balance-${side.toLowerCase()}`);
                        if (gapEl) {
                            gapEl.textContent = formatCurrency(gap);
                            gapEl.style.color = getGapColor(gap);
                        }
                        if (balEl) {
                            balEl.textContent = formatCurrency(personalFunds);
                        }

                        const chartId = `compare-chart-${side.toLowerCase()}`;
                        createCashFlowChart(chartId, dur, personalFunds, monthlyLiving, tuition, monthlyIncome);
                    });
                };

                // Attach listeners for interactive comparison recalculation
                const compareInputs = document.querySelectorAll('#sidebar-controls input, #sidebar-controls select');
                compareInputs.forEach(input => {
                    input.addEventListener('change', recalcComparisonFromSidebar);
                });

                // Initial charts for A and B
                createCashFlowChart('compare-chart-a', durationA, personalFundsA, monthlyLivingA, tuitionA);
                createCashFlowChart('compare-chart-b', durationB, personalFundsB, monthlyLivingB, tuitionB);
                
                // Render cards and charts for C and D if they exist
                if (window.comparePrograms.C) {
                    const progC = window.comparePrograms.C;
                    renderProgramCard('C', progC);
                    createCashFlowChart('compare-chart-c', progC.duration, progC.personalFunds, progC.monthlyLiving, progC.tuition);
                    document.getElementById('compare-chart-title-c').textContent = `24-Month Cash Flow: ${progC.name}`;
                }
                
                if (window.comparePrograms.D) {
                    const progD = window.comparePrograms.D;
                    renderProgramCard('D', progD);
                    createCashFlowChart('compare-chart-d', progD.duration, progD.personalFunds, progD.monthlyLiving, progD.tuition);
                    document.getElementById('compare-chart-title-d').textContent = `24-Month Cash Flow: ${progD.name}`;
                }
                
                // Update visibility of add program placeholders
                updateAddProgramPlaceholders();
            }
        });

        // Toggle to single view from comparison
        window.openSingleFromCompare = function (side) {
            if (!window.comparePrograms || !window.comparePrograms[side]) return;
            const prog = window.comparePrograms[side];
            const mainContentArea = document.getElementById('main-content-area');
            const singleView = document.getElementById('single-result-view');
            const compareView = document.getElementById('compare-result-view');

            // Mark that we're coming from comparison
            window.isFromComparison = true;

            showSidebar();
            if (mainContentArea) {
                mainContentArea.classList.remove('lg:col-span-4');
                mainContentArea.classList.add('lg:col-span-3');
            }
            if (singleView) singleView.classList.remove('hidden-view');
            if (compareView) compareView.classList.add('hidden-view');

            // Show back button in sidebar and hide comparison sections
            const backBtn = document.getElementById('back-to-comparison-btn');
            const comparisonPreview = document.getElementById('comparison-preview');
            const compareAnotherCard = document.getElementById('compare-another-card');
            if (backBtn) backBtn.classList.remove('hidden');
            if (comparisonPreview) comparisonPreview.classList.add('hidden');
            if (compareAnotherCard) compareAnotherCard.classList.add('hidden');

            // Populate sidebar inputs with selected program data
            document.getElementById('single-title').textContent = `Your Financial Roadmap: ${prog.name}`;
            document.getElementById('save-button').textContent = 'Save Plan to Dashboard';

            document.getElementById('input-savings').value = prog.savings || 0;
            document.getElementById('input-family').value = prog.family || 0;
            document.getElementById('input-scholarships').value = prog.scholarships || 0;
            document.getElementById('input-tuition').value = prog.tuition || 0;
            document.getElementById('input-duration').value = prog.duration || 24;
            document.getElementById('input-living-monthly').value = Math.round(prog.monthlyLivingInput || prog.monthlyLiving || 1400);
            document.getElementById('input-home-salary-result').value = 0;
            document.getElementById('input-oncampus-income').value = 0;
            document.getElementById('input-lifestyle').value = prog.lifestyle === 'frugal' ? 900 : prog.lifestyle === 'comfortable' ? 2100 : 1400;

            updateDashboard();

            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
        };

        // Return to comparison view
        window.showCompareView = function () {
            const mainContentArea = document.getElementById('main-content-area');
            const singleView = document.getElementById('single-result-view');
            const compareView = document.getElementById('compare-result-view');

            // Mark that we're back in comparison view
            window.isFromComparison = false;

            showSidebar();
            if (mainContentArea) {
                mainContentArea.classList.remove('lg:col-span-4');
                mainContentArea.classList.add('lg:col-span-3');
            }
            if (compareView) compareView.classList.remove('hidden-view');
            if (singleView) singleView.classList.add('hidden-view');

            // Hide back button in sidebar and show comparison sections again
            const backBtn = document.getElementById('back-to-comparison-btn');
            const comparisonPreview = document.getElementById('comparison-preview');
            const compareAnotherCard = document.getElementById('compare-another-card');
            if (backBtn) backBtn.classList.add('hidden');
            if (comparisonPreview) comparisonPreview.classList.remove('hidden');
            if (compareAnotherCard) compareAnotherCard.classList.remove('hidden');

            window.scrollTo({ top: 0, behavior: 'smooth' });
        };

        // Update comparison count badge
        const updateCompareCountBadge = () => {
            const count = ['A', 'B', 'C', 'D'].filter(s => window.comparePrograms && window.comparePrograms[s]).length;
            const badge = document.getElementById('compare-count-badge');
            if (badge) {
                badge.textContent = `${count} program${count !== 1 ? 's' : ''}`;
            }
        };

        // Show/hide add program placeholders based on current state
        const updateAddProgramPlaceholders = () => {
            const hasC = window.comparePrograms && window.comparePrograms.C;
            const hasD = window.comparePrograms && window.comparePrograms.D;
            
            const cardC = document.getElementById('compare-card-c');
            const cardD = document.getElementById('compare-card-d');
            const chartsRow2 = document.getElementById('compare-charts-row-2');
            const chartSectionC = document.getElementById('compare-chart-section-c');
            const chartSectionD = document.getElementById('compare-chart-section-d');
            
            // Show D placeholder only if C is filled
            if (cardD) {
                if (hasC && !hasD) {
                    cardD.classList.remove('hidden');
                } else if (hasD) {
                    cardD.classList.remove('hidden');
                } else {
                    cardD.classList.add('hidden');
                }
            }
            
            // Show charts row 2 if C or D exists
            if (chartsRow2) {
                if (hasC || hasD) {
                    chartsRow2.classList.remove('hidden');
                } else {
                    chartsRow2.classList.add('hidden');
                }
            }
            
            // Show individual chart sections
            if (chartSectionC) chartSectionC.classList.toggle('hidden', !hasC);
            if (chartSectionD) chartSectionD.classList.toggle('hidden', !hasD);
            
            updateCompareCountBadge();
        };

        // Focus on search input for adding program (C or D)
        window.addProgramToComparison = function (slot) {
            // Just render the placeholder with search and focus
            renderAddProgramPlaceholder(slot);
            setTimeout(() => {
                const input = document.getElementById(`compare-search-input-${slot.toLowerCase()}`);
                if (input) input.focus();
            }, 100);
        };

        // Render a program card (filled state)
        const renderProgramCard = (side, program) => {
            const cardId = `compare-card-${side.toLowerCase()}`;
            const cardEl = document.getElementById(cardId);
            if (!cardEl || !program) return;
            
            const gapColor = program.gap > 0 ? 'text-red-600' : 'text-green-600';
            
            cardEl.className = 'relative bg-white rounded-lg border border-gray-200 text-center p-4 shadow-sm cursor-pointer hover:shadow-md transition-all';
            cardEl.onclick = () => openSingleFromCompare(side);
            cardEl.innerHTML = `
                <button type="button" class="absolute top-2 right-2 text-xs text-gray-400 hover:text-red-500"
                    onclick="event.stopPropagation(); removeCompareProgram('${side}');">✕</button>
                <h2 id="compare-name-${side.toLowerCase()}" class="text-lg font-bold text-gray-900 mb-3">${program.name}</h2>
                <p class="text-sm text-gray-700 mb-1">Total Funding Gap:</p>
                <p id="compare-gap-${side.toLowerCase()}" class="text-3xl font-bold ${gapColor} my-3">${formatCurrency(program.gap)}</p>
                <p class="text-xs text-gray-600">Starting Balance: <span id="compare-balance-${side.toLowerCase()}"
                        class="font-semibold">${formatCurrency(program.personalFunds)}</span></p>
            `;
        };

        // Universities database for comparison search
        const comparisonUniversitiesDB = (() => {
            const data = [];
            const countries = [
                { code: 'US', name: 'United States', livingCost: 1500 },
                { code: 'UK', name: 'United Kingdom', livingCost: 1400 },
                { code: 'ES', name: 'Spain', livingCost: 900 },
                { code: 'FR', name: 'France', livingCost: 1200 },
                { code: 'DE', name: 'Germany', livingCost: 1000 },
                { code: 'NL', name: 'Netherlands', livingCost: 1100 },
                { code: 'CH', name: 'Switzerland', livingCost: 1600 },
                { code: 'IT', name: 'Italy', livingCost: 950 },
                { code: 'CA', name: 'Canada', livingCost: 1200 },
                { code: 'AU', name: 'Australia', livingCost: 1300 },
                { code: 'SG', name: 'Singapore', livingCost: 1400 },
                { code: 'HK', name: 'Hong Kong', livingCost: 1500 }
            ];
            
            const universities = {
                'US': ['Harvard University', 'Stanford University', 'MIT', 'Wharton', 'Columbia University', 'University of Chicago', 'Northwestern University', 'Yale University', 'Duke University', 'UC Berkeley', 'UCLA', 'NYU Stern'],
                'UK': ['Oxford University', 'Cambridge University', 'London Business School', 'Imperial College', 'LSE', 'Warwick', 'Manchester', 'Edinburgh'],
                'ES': ['IE Business School', 'ESADE', 'IESE Business School'],
                'FR': ['INSEAD', 'HEC Paris', 'ESSEC', 'Sciences Po'],
                'DE': ['WHU', 'Mannheim Business School', 'Frankfurt School', 'ESMT Berlin'],
                'NL': ['Rotterdam School of Management', 'Amsterdam Business School'],
                'CH': ['University of St. Gallen', 'IMD', 'ETH Zurich'],
                'IT': ['Bocconi University', 'SDA Bocconi'],
                'CA': ['Rotman', 'Ivey Business School', 'McGill University'],
                'AU': ['Melbourne Business School', 'UNSW', 'University of Sydney'],
                'SG': ['NUS', 'Nanyang Business School', 'Singapore Management University'],
                'HK': ['HKU', 'HKUST', 'CUHK']
            };
            
            const programs = ['MBA', 'Master of Finance', 'Master in Management', 'Master of Data Science', 'Master of Marketing', 'MSc Economics', 'Master of Accounting', 'LLM'];
            
            Object.keys(universities).forEach(countryCode => {
                const country = countries.find(c => c.code === countryCode);
                if (!country) return;
                
                universities[countryCode].forEach(uni => {
                    programs.forEach(prog => {
                        const baseTuition = countryCode === 'US' ? 65000 : countryCode === 'UK' ? 45000 : 35000;
                        const tuitionVariation = 0.7 + Math.random() * 0.6;
                        const tuition = Math.round(baseTuition * tuitionVariation);
                        const duration = prog === 'MBA' ? 24 : (Math.random() > 0.5 ? 12 : 24);
                        
                        data.push({
                            name: uni,
                            program: prog,
                            country: countryCode,
                            countryName: country.name,
                            tuition: tuition,
                            duration: duration,
                            livingCost: country.livingCost
                        });
                    });
                });
            });
            
            return data;
        })();

        // Search in comparison card (exposed globally) - searches university, program, AND country
        window.searchInComparisonCard = function(query, slot) {
            const resultsId = `compare-search-results-${slot.toLowerCase()}`;
            const resultsDiv = document.getElementById(resultsId);
            if (!resultsDiv) return;
            
            if (query.length < 2) {
                resultsDiv.classList.add('hidden');
                resultsDiv.innerHTML = '';
                return;
            }
            
            const queryLower = query.toLowerCase();
            
            // Search by university, program, OR country
            const matches = comparisonUniversitiesDB.filter(item => {
                const uniMatch = item.name.toLowerCase().includes(queryLower);
                const programMatch = item.program.toLowerCase().includes(queryLower);
                const countryMatch = item.countryName.toLowerCase().includes(queryLower);
                return uniMatch || programMatch || countryMatch;
            }).slice(0, 8);
            
            if (matches.length === 0) {
                resultsDiv.innerHTML = '<div class="p-3 text-center text-gray-500 text-sm">No results. Try country, university, or program.</div>';
            } else {
                resultsDiv.innerHTML = matches.map(item => {
                    const countryMatch = item.countryName.toLowerCase().includes(queryLower);
                    return `
                    <div class="border-b border-gray-100 px-3 py-2 cursor-pointer hover:bg-indigo-50 transition-all text-left"
                         onclick="selectProgramForComparison('${slot}', '${item.name.replace(/'/g, "\\'")}', '${item.program.replace(/'/g, "\\'")}', '${item.country}', '${item.countryName}', ${item.tuition}, ${item.duration}, ${item.livingCost})">
                        <div class="flex items-center gap-2">
                            <span class="font-semibold text-gray-900 text-sm">${item.name}</span>
                            <span class="text-xs px-1.5 py-0.5 rounded-full ${countryMatch ? 'bg-indigo-100 text-indigo-700' : 'bg-gray-100 text-gray-500'}">${item.countryName}</span>
                        </div>
                        <div class="text-xs text-gray-600">${item.program}</div>
                        <div class="text-xs font-bold text-indigo-600 mt-1">$${item.tuition.toLocaleString()} • ${item.duration}mo</div>
                    </div>
                    `;
                }).join('');
            }
            
            resultsDiv.classList.remove('hidden');
        };

        // Select program and add to comparison
        window.selectProgramForComparison = function(slot, uniName, programName, countryCode, countryName, tuition, duration, livingCost) {
            // Get current sidebar funds
            const savings = parseFloat(document.getElementById('input-savings').value) || 0;
            const family = parseFloat(document.getElementById('input-family').value) || 0;
            const scholarships = parseFloat(document.getElementById('input-scholarships').value) || 0;
            const loans = parseFloat(document.getElementById('input-loans').value) || 0;
            const monthlyLiving = parseFloat(document.getElementById('input-living-monthly').value) || livingCost;
            
            const personalFunds = savings + family + scholarships + loans;
            const livingTotal = monthlyLiving * duration;
            const totalCost = tuition + livingTotal;
            const gap = totalCost - personalFunds;
            
            // Create program object
            const program = {
                name: `${uniName} - ${programName}`,
                tuition: tuition,
                living: livingTotal,
                cost: totalCost,
                gap: gap,
                duration: duration,
                personalFunds: personalFunds,
                monthlyLiving: monthlyLiving,
                savings: savings,
                family: family,
                scholarships: scholarships,
                lifestyle: 'balanced',
                monthlyLivingInput: monthlyLiving
            };
            
            // Add to comparePrograms
            if (!window.comparePrograms) window.comparePrograms = { A: null, B: null, C: null, D: null };
            window.comparePrograms[slot] = program;
            
            // Render the card with program data
            renderProgramCard(slot, program);
            
            // Create chart
            const chartId = `compare-chart-${slot.toLowerCase()}`;
            document.getElementById(`compare-chart-title-${slot.toLowerCase()}`).textContent = `24-Month Cash Flow: ${program.name}`;
            createCashFlowChart(chartId, duration, personalFunds, monthlyLiving, tuition);
            
            // Update placeholders
            updateAddProgramPlaceholders();
        };

        // Render empty "Add Program" placeholder with search
        const renderAddProgramPlaceholder = (side) => {
            const cardId = `compare-card-${side.toLowerCase()}`;
            const cardEl = document.getElementById(cardId);
            if (!cardEl) return;
            
            const number = side === 'C' ? '3rd' : '4th';
            
            cardEl.className = 'relative border-2 border-dashed border-gray-300 rounded-lg p-4 transition-all';
            cardEl.onclick = null;
            cardEl.innerHTML = `
                <div class="text-center mb-3">
                    <h3 class="text-lg font-semibold text-gray-700">Add ${number} Program</h3>
                    <p class="text-xs text-gray-500">Search to compare another option</p>
                </div>
                <div class="relative">
                    <div class="flex items-center border border-gray-300 rounded-lg focus-within:border-indigo-500 focus-within:ring-2 focus-within:ring-indigo-100 bg-white">
                        <div class="pl-3 pr-2">
                            <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                            </svg>
                        </div>
                        <input type="text" id="compare-search-input-${side.toLowerCase()}"
                            class="flex-1 py-2 pr-3 text-sm border-0 focus:outline-none focus:ring-0 bg-transparent"
                            placeholder="Try country, university, or program..."
                            oninput="searchInComparisonCard(this.value, '${side}')"
                            autocomplete="off">
                    </div>
                    <div id="compare-search-results-${side.toLowerCase()}"
                        class="hidden absolute w-full bg-white border border-gray-200 rounded-lg shadow-lg mt-1 max-h-48 overflow-y-auto z-20">
                    </div>
                </div>
            `;
        };

        // Remove a program from comparison without leaving results page
        window.removeCompareProgram = function (side) {
            if (!window.comparePrograms) return;
            
            const cardId = `compare-card-${side.toLowerCase()}`;
            const chartId = `compare-chart-${side.toLowerCase()}`;

            // Clear stored data
            window.comparePrograms[side] = null;

            // For C and D, convert back to placeholder
            if (side === 'C' || side === 'D') {
                renderAddProgramPlaceholder(side);
                destroyChart(chartId);
                updateAddProgramPlaceholders();
                return;
            }

            // For A and B, show removed message
            const cardEl = document.getElementById(cardId);
            if (cardEl) {
                cardEl.innerHTML = `
                    <div class="h-full flex flex-col items-center justify-center text-center text-gray-500 text-sm py-6">
                        <div class="text-3xl text-gray-300 mb-2">○</div>
                        <p class="mb-2">Program removed.</p>
                        <button onclick="event.stopPropagation(); addProgramToComparison('${side}')" 
                            class="text-indigo-600 hover:text-indigo-800 font-semibold">
                            + Add another program
                        </button>
                    </div>
                `;
                cardEl.classList.remove('cursor-pointer');
                cardEl.onclick = null;
            }

            // Clear chart
            destroyChart(chartId);
            updateCompareCountBadge();
        };

        // Save plan or comparison to dashboard (localStorage)
        window.savePlanToDashboard = function() {
            const params = new URLSearchParams(window.location.search);
            const simType = params.get('simType') || 'single';
            
            // Get existing saved plans
            let savedPlans = [];
            try {
                const stored = localStorage.getItem('masterplan_saved_plans');
                savedPlans = stored ? JSON.parse(stored) : [];
            } catch (e) {
                savedPlans = [];
            }
            
            const now = new Date().toISOString();
            const generateId = () => 'plan_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            
            if (simType === 'compare' && window.comparePrograms) {
                // Save comparison - save each program as a separate card
                const programsToSave = ['A', 'B', 'C', 'D'].filter(s => window.comparePrograms[s]);
                
                programsToSave.forEach(side => {
                    const prog = window.comparePrograms[side];
                    if (!prog) return;
                    
                    // Check if already saved (by name)
                    const exists = savedPlans.find(p => p.name === prog.name);
                    if (exists) return; // Skip duplicates
                    
                    savedPlans.push({
                        id: generateId(),
                        name: prog.name,
                        tuition: prog.tuition,
                        living: prog.living,
                        cost: prog.cost,
                        gap: prog.gap,
                        duration: prog.duration,
                        personalFunds: prog.personalFunds,
                        type: 'comparison',
                        programs: programsToSave.length,
                        savedAt: now,
                        viewUrl: `results.html?simType=single&nameA=${encodeURIComponent(prog.name)}&tuitionA=${prog.tuition}&livingA=${prog.living}&costA=${prog.cost}&gapA=${prog.gap}&duration=${prog.duration}`
                    });
                });
            } else {
                // Save single plan
                const nameA = params.get('nameA') || document.getElementById('single-title').textContent.replace('Your Financial Roadmap: ', '');
                const tuition = parseFloat(document.getElementById('input-tuition').value) || 0;
                const duration = parseFloat(document.getElementById('input-duration').value) || 24;
                const monthlyLiving = parseFloat(document.getElementById('input-living-monthly').value) || 1400;
                const livingTotal = monthlyLiving * duration;
                
                const savings = parseFloat(document.getElementById('input-savings').value) || 0;
                const family = parseFloat(document.getElementById('input-family').value) || 0;
                const scholarships = parseFloat(document.getElementById('input-scholarships').value) || 0;
                const loans = parseFloat(document.getElementById('input-loans').value) || 0;
                const personalFunds = savings + family + scholarships + loans;
                
                const cost = tuition + livingTotal;
                const gap = cost - personalFunds;
                
                // Check if already saved (by name)
                const exists = savedPlans.find(p => p.name === nameA);
                if (!exists) {
                    savedPlans.push({
                        id: generateId(),
                        name: nameA,
                        tuition: tuition,
                        living: livingTotal,
                        cost: cost,
                        gap: gap,
                        duration: duration,
                        personalFunds: personalFunds,
                        type: 'single',
                        savedAt: now,
                        viewUrl: window.location.href
                    });
                }
            }
            
            // Save to localStorage
            localStorage.setItem('masterplan_saved_plans', JSON.stringify(savedPlans));
            
            // Show success feedback and redirect
            const btn = document.getElementById('save-button');
            const originalText = btn.textContent;
            btn.textContent = '✓ Saved!';
            btn.classList.add('bg-green-600');
            btn.classList.remove('gradient-bg');
            
            setTimeout(() => {
                window.location.href = 'dashboard.html';
            }, 800);
        };
    </script>
    <script type="module" src="./js/auth-state.js"></script>
    <script>
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar-controls');
            const toggleBtn = document.getElementById('sidebar-toggle');
            const mainContent = document.getElementById('main-content-area');

            // Check if currently hidden (checking lg:hidden or hidden class)
            const isHidden = sidebar.classList.contains('hidden') || sidebar.classList.contains('lg:hidden');

            if (isHidden) {
                // Show sidebar
                sidebar.classList.remove('hidden');
                sidebar.classList.remove('lg:hidden');
                sidebar.classList.add('lg:block');

                // Adjust main content width
                mainContent.classList.remove('lg:col-span-4');
                mainContent.classList.add('lg:col-span-3');

                toggleBtn.innerHTML = `
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                    <span>Hide Filters</span>
                `;
            } else {
                // Hide sidebar
                sidebar.classList.add('hidden');
                sidebar.classList.add('lg:hidden');
                sidebar.classList.remove('lg:block');

                // Adjust main content width
                mainContent.classList.remove('lg:col-span-3');
                mainContent.classList.add('lg:col-span-4');

                toggleBtn.innerHTML = `
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                    </svg>
                    <span>Show Filters</span>
                `;
            }
        }
    </script>
</body>

</html>